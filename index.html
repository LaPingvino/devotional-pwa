<!doctype html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Noto+Sans+Symbols+2"
        />
        <link
            rel="stylesheet"
            href="https://code.getmdl.io/1.3.0/material.blue_grey-blue.min.css"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="manifest" href="devotional.webmanifest" />
        <link rel="icon" href="/chrome/chrome-favicon-16-16.png" />
        <script
            defer
            src="https://code.getmdl.io/1.3.0/material.min.js"
        ></script>
        <title>&#x1f7d9; Holywritings.net</title>
    </head>
    <body>
        <style>
            .star {
                font-family: "Noto Sans Symbols 2";
                font-size: 1.5em;
                color: gold;
            }
            body {
                font-size: 1.3em;
                background-color: #f4f6f6;
            }

            /* New styles for two-column layout */
            #main-view-container {
                display: flex;
                flex-wrap: wrap; /* Allow columns to wrap on smaller screens */
                padding: 10px; /* Outer padding for the entire two-column area */
            }

            #content-column {
                flex: 3; /* Main content takes more space, e.g., ~75% */
                min-width: 0; /* Important for flex item shrinking */
                display: flex; /* To allow #content to be a card within */
                flex-direction: column;
            }

            #content {
                position: relative; /* For favorite button positioning */
                margin: 15px; /* Card-like margin */
                background-color: #ffffff;
                padding: 20px;
                border-radius: 4px;
                box-shadow:
                    0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12);
            }

            #prayer-matching-tool {
                flex: 1; /* Tool takes less space, e.g., ~25% */
                min-width: 320px; /* Minimum width for the tool */
                margin: 15px; /* Card-like margin */
                padding: 20px;
                background-color: #fffde7; /* Light Yellow */
                border-radius: 4px;
                box-shadow:
                    0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12);
                align-self: flex-start; /* Keep it at the top of the flex row */
                max-height: calc(
                    100vh - 100px
                ); /* Adjust based on header/margins */
                overflow-y: auto; /* Make tool scrollable if content exceeds max-height */
            }

            #contribution-section {
                margin: 0 25px 25px 25px; /* Align with cards above (10px padding + 15px margin) */
                padding: 20px;
                background-color: #e8f5e9;
                border-radius: 4px;
                box-shadow:
                    0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12);
            }

            @media screen and (max-width: 1024px) {
                /* Breakpoint for stacking columns */
                #main-view-container {
                    flex-direction: column;
                    padding: 5px; /* Reduce padding when stacked */
                }
                #content-column {
                    order: 1; /* Content first */
                }
                #prayer-matching-tool {
                    order: 2; /* Tool second */
                    min-width: 0; /* Allow it to be full width, override base 320px */
                    max-height: none; /* Allow full height for content */
                    overflow-y: visible;
                }
                #contribution-section {
                    /* #main-view-container padding 5px + #content margin 15px = 20px effective indent */
                    /* So, #contribution-section needs L/R margin 20px to align */
                    margin: 15px 20px; /* Consistent margin for stacked layout, L/R adjusted */
                }
            }

            @media screen and (max-width: 480px) {
                #main-view-container {
                    padding: 0; /* No padding for the container on very small screens */
                }
                #content,
                #prayer-matching-tool,
                #contribution-section {
                    margin: 10px; /* Reduce margins for cards, all will align as parent padding is 0 */
                    padding: 15px; /* Reduce padding inside cards */
                }
            }

            /* Header fixes for mobile visibility */
            @media screen and (max-width: 767px) {
                /* Mobile and small tablets */
                .mdl-layout__header-row {
                    padding-right: 8px; /* Reduce right padding for more space for icons/nav */
                }
                .mdl-layout__header-row .mdl-layout-title {
                    font-size: 1rem; /* Smaller title */
                    flex: 0 1 auto; /* Allow title to shrink but not grow, auto basis */
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                .mdl-layout__header-row .mdl-textfield--expandable {
                    flex-shrink: 0;
                }
                .mdl-layout__header-row
                    .mdl-textfield--expandable
                    > .mdl-button--icon {
                    margin-right: 2px;
                }

                .mdl-layout__header-row #prayer-language-nav {
                    flex-shrink: 0;
                }
                .mdl-layout__header-row
                    #prayer-language-nav.mdl-navigation
                    .mdl-navigation__link {
                    padding: 0 4px;
                    font-size: 0.75em;
                    white-space: nowrap;
                }
                .mdl-layout__header-row #prayer-language-nav .mdl-button--icon {
                    margin-left: 2px;
                }
            }
            /* Drawer specific styles */
            .mdl-layout__drawer #drawer-prayer-language-nav {
                padding-top: 0;
                padding-bottom: 8px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                margin-bottom: 8px;
                max-height: 150px; /* Limit height and make scrollable if many languages */
                overflow-y: auto;
            }
            .mdl-layout__drawer
                #drawer-prayer-language-nav
                .mdl-navigation__link {
                color: rgba(
                    0,
                    0,
                    0,
                    0.87
                ); /* Standard text color for drawer links */
            }
            .mdl-layout__drawer .main-drawer-nav {
                /* Class for original nav items */
                padding-top: 8px;
            }

            #content a {
                font-weight: bold;
                padding: 3px;
            }
            #content a + a::before {
                content: " - ";
            }
            #content .prayer-list-item a + a::before,
            #content .prayer-code-list-item a + a::before {
                content: "";
            }
            #content .other-versions-in-lang-list a + a::before {
                /* Remove dash for this specific list */
                content: "";
            }

            .author::before {
                content: "--";
            }
            header, /* This refers to the <header> inside #content, not the main layout header */
            .scripture {
                padding-left: 1em;
            }
            .scripture {
                font-family: "Gentium", "Times New Roman", serif;
                border-left: black solid 2px;
                max-width: 800px; /* Keep scripture text from being too wide */
            }
            .author {
                margin-top: 1em;
                margin-left: 2em;
                font-weight: bold;
            }
            h2 {
                /* Applies to h2 within #content and #prayer-matching-tool */
                font-size: 1.2em;
            }
            #category {
                font-size: 1.2em;
                font-weight: bold;
            }
            #blocktitle {
                color: #777777;
            }
            small {
                /* Applies to small in drawer */
                font-family: "Gentium", "Times New Roman", serif;
                font-size: 0.9em;
                display: block;
                margin: 5px;
                margin-top: 20px;
            }
            .prayer-list-item {
                /* May become unused but kept for now */
                margin-bottom: 0.5em;
            }
            .pagination {
                margin-top: 20px;
                text-align: center;
            }
            .pagination button {
                margin: 0 5px;
            }
            .mdl-layout__header-row .mdl-textfield__input {
                color: white;
            }
            .mdl-layout__header-row .mdl-textfield__label:after {
                background-color: white;
            }
            .language-buttons-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                padding: 10px 0;
            }
            .language-buttons-container .mdl-button {
                margin: 5px;
                text-transform: uppercase;
            }
            .language-buttons-container .mdl-button.lang-button-green {
                background-color: #4caf50; /* Green */
                color: white;
            }
            .language-buttons-container .mdl-button.lang-button-yellow {
                background-color: #ffeb3b; /* Yellow */
                color: #333; /* Darker text for yellow bg */
            }
            .language-buttons-container .mdl-button.lang-button-green:hover,
            .language-buttons-container .mdl-button.lang-button-yellow:hover {
                opacity: 0.8;
            }

            #prayer-language-nav .mdl-menu__container {
                /* Header language menu */
                z-index: 10001 !important;
            }
            #drawer-prayer-language-nav .mdl-menu__container {
                /* Drawer language menu, if it were to become one */
                z-index: 10001 !important; /* Ensure drawer menus are also on top */
            }
            .prayer-actions {
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid #eee;
            }
            .prayer-actions .mdl-button .material-icons {
                margin-right: 8px;
            }

            /* Prayer Matching Tool Specific Styles */
            #prayer-matching-tool h4 {
                margin-top: 0;
                color: #3f51b5;
            }
            #prayer-matching-tool h5 {
                color: #546e7a;
            }
            #pinned-prayer-section > p {
                /* Styles the metadata paragraph */
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 10px; /* Space before text display or if no text */
            }
            #pinned-prayer-section .mdl-button--icon {
                margin-left: 10px;
            }
            #pinned-prayer-text-display {
                /* For the actual pinned prayer text */
                margin-top: 10px;
                padding: 10px;
                background-color: #fdfdfd;
                border: 1px solid #e0e0e0;
                border-radius: 4px;
                max-height: 250px;
                overflow-y: auto;
                white-space: pre-wrap;
                font-size: 0.9em;
                line-height: 1.4;
            }

            /* Favorite Prayer Styles (now general prayer card styles) */
            .favorite-toggle-button {
                position: absolute;
                top: 10px; /* Adjusted to be slightly inside padding */
                right: 10px; /* Adjusted */
                color: #bdbdbd; /* Default (not favorite) */
                z-index: 10; /* Ensure it's above other content */
            }
            .favorite-toggle-button.is-favorite {
                color: gold; /* Favorited */
            }
            .favorite-toggle-button .material-icons {
                font-size: 28px; /* Adjust size */
            }

            #favorite-prayers-section {
                /* Specific container for favorites on home page */
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #ddd;
            }
            #favorite-prayers-section h3 {
                font-size: 1.1em;
                color: #3f51b5; /* Consistent with other tool titles */
                margin-top: 0; /* Align with card content */
                margin-bottom: 10px;
            }

            /* General Prayer Card Grid Styles (reusing .favorite-prayer-grid) */
            .favorite-prayer-grid {
                /* Applied to all card lists now */
                display: grid;
                grid-template-columns: repeat(
                    auto-fill,
                    minmax(300px, 1fr)
                ); /* Responsive grid */
                gap: 15px; /* Space between cards */
            }

            /* General Prayer Card Styles (reusing .favorite-prayer-card) */
            .favorite-prayer-card {
                /* Applied to all prayer cards now */
                background-color: #fff;
                border: 1px solid #e0e0e0;
                border-radius: 4px;
                padding: 15px;
                box-shadow:
                    0 1px 3px rgba(0, 0, 0, 0.12),
                    0 1px 2px rgba(0, 0, 0, 0.24);
                display: flex;
                flex-direction: column;
                justify-content: space-between; /* Pushes translations to the bottom */
                min-height: 150px; /* Ensure a minimum height */
            }

            .favorite-prayer-card-header {
                font-size: 1.1em;
                font-weight: bold;
                margin-bottom: 8px;
                color: #3f51b5;
            }
            .favorite-prayer-card-header a {
                text-decoration: none;
                color: inherit;
            }

            .favorite-prayer-card-preview {
                font-size: 0.9em;
                color: #555;
                margin-bottom: 10px;
                line-height: 1.4;
                overflow: hidden;
                display: -webkit-box;
                -webkit-line-clamp: 3; /* Limit to 3 lines */
                -webkit-box-orient: vertical;
                max-height: calc(
                    1.4em * 3
                ); /* Fallback for max-height based on line-height and clamp */
            }

            .favorite-prayer-card-meta {
                font-size: 0.8em;
                color: #777;
                margin-bottom: 10px;
            }
            .favorite-prayer-card-meta span {
                margin-right: 10px;
                display: inline-block; /* Ensure proper spacing */
            }
            .favorite-prayer-card-meta .phelps-code a {
                color: #007bff;
                text-decoration: none;
            }
            .favorite-prayer-card-meta .phelps-code a:hover {
                text-decoration: underline;
            }

            .favorite-prayer-card-translations {
                margin-top: auto; /* Pushes to bottom if card is taller */
                padding-top: 10px;
                border-top: 1px solid #eee;
            }

            .favorite-prayer-card-translations h5 {
                font-size: 0.85em;
                color: #546e7a;
                margin-top: 0;
                margin-bottom: 5px;
            }

            .favorite-prayer-card-translations-list {
                /* For other language links */
                list-style: none;
                padding: 0;
                margin: 0;
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }

            .favorite-prayer-card-translations-item a {
                font-size: 0.8em;
                text-decoration: none;
                color: #1976d2;
                background-color: #e3f2fd;
                padding: 2px 6px;
                border-radius: 3px;
                transition: background-color 0.2s;
            }
            .favorite-prayer-card-translations-item a:hover {
                background-color: #bbdefb;
            }

            .other-versions-in-lang-list {
                /* For same language, different version links */
                list-style: disc;
                padding-left: 20px;
                font-size: 0.8em; /* Slightly smaller */
                margin: 0;
            }
            .other-versions-in-lang-list li {
                margin-bottom: 3px;
            }
            .other-versions-in-lang-list a {
                text-decoration: none;
                color: #007bff;
            }
            .other-versions-in-lang-list a:hover {
                text-decoration: underline;
            }

            .filter-switch-container {
                margin-bottom: 15px;
                padding: 10px;
                background-color: #f9f9f9;
                border-radius: 4px;
                display: flex;
                align-items: center;
            }
        </style>

        <div class="mdl-layout mdl-js-layout">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <a
                        href="#"
                        onclick="window.location.hash='#'; return false;"
                        class="mdl-layout-title"
                        style="color: white; text-decoration: none"
                    >
                        <span class="star">&#x1f7d9;</span> Holy Writings Reader
                    </a>
                    <div class="mdl-layout-spacer"></div>
                    <div
                        class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right"
                        style="margin-right: 2px"
                    >
                        <label
                            class="mdl-button mdl-js-button mdl-button--icon"
                            for="header-search-field"
                        >
                            <i class="material-icons">search</i>
                        </label>
                        <div class="mdl-textfield__expandable-holder">
                            <input
                                class="mdl-textfield__input"
                                type="text"
                                id="header-search-field"
                                placeholder="Search Prayers"
                            />
                            <label
                                class="mdl-textfield__label"
                                for="header-search-field"
                            ></label>
                        </div>
                    </div>
                    <nav class="mdl-navigation" id="prayer-language-nav">
                        <a class="mdl-navigation__link" href="">Loading...</a>
                    </nav>
                </div>
            </header>
            <div class="mdl-layout__drawer">
                <a
                    href="#"
                    onclick="window.location.hash='#'; document.querySelector('.mdl-layout').MaterialLayout.toggleDrawer(); return false;"
                    class="mdl-layout-title"
                    style="
                        color: rgba(0, 0, 0, 0.87);
                        text-decoration: none;
                        display: block;
                        padding: 16px;
                        margin-bottom: 8px;
                        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                        font-size: 1.2em;
                        font-weight: 500;
                    "
                >
                    <span
                        class="star"
                        style="font-size: 1.2em; vertical-align: middle"
                        >&#x1f7d9;</span
                    >
                    Holy Writings
                </a>
                <div style="padding: 0 16px 8px 16px">
                    <div
                        class="mdl-textfield mdl-js-textfield"
                        style="width: 100%; padding: 0"
                    >
                        <input
                            class="mdl-textfield__input"
                            type="text"
                            id="drawer-search-field"
                            placeholder="Search Prayers"
                        />
                        <!-- <label class="mdl-textfield__label" for="drawer-search-field">Search...</label> -->
                    </div>
                </div>
                <nav class="mdl-navigation" id="drawer-prayer-language-nav">
                    <span
                        class="mdl-navigation__link"
                        style="font-style: italic; color: #757575"
                        >Languages N/A</span
                    >
                </nav>
                <nav class="mdl-navigation main-drawer-nav">
                    <a class="mdl-navigation__link" href="#prayers">Prayers</a>
                    <a class="mdl-navigation__link" href="#songs">Songs</a>
                    <a class="mdl-navigation__link" href="#books">Books</a>
                    <a class="mdl-navigation__link" href="#programs"
                        >Programs</a
                    >
                </nav>
                <img
                    src="windows10/StoreLogo.scale-400.png"
                    style="
                        margin: 50px auto;
                        width: 100px;
                        height: 100px;
                        display: block;
                        clear: both;
                    "
                />
                <div>
                    <small
                        >Contribute on
                        <a href="https://tiddly.holywritings.net"
                            >tiddly.holywritings.net</a
                        >
                        - Put together by Joop Kiefte</small
                    >
                </div>
            </div>
            <main class="mdl-layout__content">
                <div id="main-view-container">
                    <div id="content-column">
                        <div id="content">
                            <!-- Content will be dynamically loaded here -->
                            <p>Loading content...</p>
                        </div>
                    </div>
                    <div id="prayer-matching-tool">
                        <h4>Prayer Matching Helper</h4>
                        <div id="pinned-prayer-section">
                            <!-- Pinned prayer info and Unpin button will go here -->
                            <p>No prayer is currently pinned.</p>
                            <!-- Pinned prayer text will be appended here by JS -->
                        </div>
                        <div
                            id="collected-matches-section"
                            style="margin-top: 15px"
                        >
                            <h5>Collected Matches for Email:</h5>
                            <ul
                                id="collected-matches-list"
                                style="
                                    list-style-type: disc;
                                    padding-left: 20px;
                                    margin-top: 5px;
                                "
                            >
                                <li>No matches collected yet.</li>
                            </ul>
                        </div>
                        <button
                            id="mail-collected-matches-button"
                            class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent"
                            disabled
                            style="margin-top: 15px"
                        >
                            <i class="material-icons">email</i> Mail Collected
                            Matches
                        </button>
                    </div>
                </div>
                <div id="contribution-section">
                    <h3>How to Contribute</h3>
                    <p>
                        You can help improve this collection of holy writings by
                        contributing in the following ways:
                    </p>
                    <ul>
                        <li>
                            <strong>Find other language versions:</strong> If
                            you find a prayer in a different language that
                            matches one on this site, please send the Phelps
                            code (if available) or the link of the page from
                            this site, along with the link of the matching
                            prayer, to
                            <a href="mailto:ikojba@gmail.com"
                                >ikojba@gmail.com</a
                            >. You can also use the "Prayer Matching Helper"
                            tool above.
                        </li>
                        <li>
                            <strong>Contribute directly on DoltHub:</strong> You
                            can contribute directly to the database on
                            <a
                                href="https://www.dolthub.com/repositories/holywritings/bahaiwritings"
                                target="_blank"
                                >dolthub.com</a
                            >.
                        </li>
                        <li>
                            <strong>Match prayers on TiddlyWiki:</strong> Visit
                            <a
                                href="https://tiddly.holywritings.net/workspace"
                                target="_blank"
                                >tiddly.holywritings.net/workspace</a
                            >
                            to match prayers. Save your results and email the
                            saved page to
                            <a href="mailto:ikojba@gmail.com"
                                >ikojba@gmail.com</a
                            >.
                        </li>
                        <li>
                            <strong>Assign missing Phelps codes</strong> Some
                            prayers don't have a Phelps code assigned to them
                            yet in any language. To correct this, you need to
                            match the prayer with its entry in
                            <a
                                href="https://afnanlibrary.org/a-partial-inventory/"
                            >
                                A Partial Inventory </a
                            >. If the prayer is part of a bigger work, you also
                            need to add a three letter suffix, usually a
                            mnemonic to its contents.
                        </li>
                    </ul>
                    <p>Your contributions are greatly appreciated!</p>
                </div>
            </main>
        </div>
        <div class="mdl-js-snackbar mdl-snackbar">
            <div class="mdl-snackbar__text"></div>
            <button class="mdl-snackbar__action" type="button"></button>
        </div>

        <script>
            // DATABASE STRUCTURE ASSUMPTIONS (holywritings/bahaiwritings):
            // Table: writings
            // Columns: version, text, language, phelps, name, source, link

            const DOLTHUB_API_BASE_URL =
                "https://www.dolthub.com/api/v1alpha1/holywritings/bahaiwritings/main?q=";
            const DOLTHUB_REPO_QUERY_URL_BASE =
                "https://www.dolthub.com/repositories/holywritings/bahaiwritings/query/main?q=";
            const MAX_DIRECT_LINKS_IN_HEADER = 4;
            const ITEMS_PER_PAGE = 20;
            const LOCALSTORAGE_PRAYER_CACHE_PREFIX = "hw_prayer_cache_";
            const FAVORITES_STORAGE_KEY = "hw_favorite_prayers";
            const MAX_PREVIEW_LENGTH = 120; // Max length for card preview text

            const contentDiv = document.getElementById("content");
            const prayerLanguageNav = document.getElementById(
                "prayer-language-nav",
            );
            const drawerPrayerLanguageNav = document.getElementById(
                "drawer-prayer-language-nav",
            );

            let currentPageByLanguage = {}; // { langCode: { page, showOnlyUnmatched } }
            let currentPageBySearchTerm = {}; // { searchTerm: page }
            let currentPageByPhelpsCode = {}; // { phelpsCode: page }
            let currentPageByPhelpsLangCode = {}; // { phelps/lang : page } - not used yet for pagination but good for state

            let pinnedPrayerDetails = null; // Stores { version, phelps, name, language, text }
            let collectedMatchesForEmail = []; // Array of objects: { pinned: {}, current: {}, description: "" }
            let favoritePrayers = []; // Stores array of {version, name, language, phelps}

            function getDomain(url) {
                if (!url) return "";
                try {
                    // Ensure the URL has a protocol, otherwise URL constructor fails
                    let fullUrl = url;
                    if (
                        !url.startsWith("http://") &&
                        !url.startsWith("https://")
                    ) {
                        fullUrl = "http://" + url;
                    }
                    return new URL(fullUrl).hostname.replace(/^www\./, "");
                } catch (e) {
                    // console.warn("Could not parse domain from URL:", url, e);
                    return ""; // Or return a snippet of the URL if desired
                }
            }

            // --- Favorite Prayer Functions ---
            function loadFavoritePrayers() {
                const storedFavorites = localStorage.getItem(
                    FAVORITES_STORAGE_KEY,
                );
                favoritePrayers = storedFavorites
                    ? JSON.parse(storedFavorites)
                    : [];
            }

            function saveFavoritePrayers() {
                localStorage.setItem(
                    FAVORITES_STORAGE_KEY,
                    JSON.stringify(favoritePrayers),
                );
            }

            function isPrayerFavorite(versionId) {
                return favoritePrayers.some((fav) => fav.version === versionId);
            }

            function toggleFavoritePrayer(prayerData) {
                const snackbarContainer =
                    document.querySelector(".mdl-js-snackbar");
                const index = favoritePrayers.findIndex(
                    (fav) => fav.version === prayerData.version,
                );
                let message = "";

                if (index > -1) {
                    favoritePrayers.splice(index, 1); // Remove
                    message = "Prayer removed from favorites.";
                } else {
                    favoritePrayers.push({
                        version: prayerData.version,
                        name: prayerData.name, // Assumes prayerData.name is already well-formed for display
                        language: prayerData.language,
                        phelps: prayerData.phelps || null, // Store Phelps code
                    });
                    message = "Prayer added to favorites.";
                }
                saveFavoritePrayers();

                if (snackbarContainer && snackbarContainer.MaterialSnackbar) {
                    snackbarContainer.MaterialSnackbar.showSnackbar({
                        message: message,
                    });
                }

                // Re-render current view to update star icon (if on prayer page) or list (if on home page)
                handleRouteChange();
            }

            // --- Prayer Matching Helper Functions ---
            function updatePrayerMatchingToolDisplay() {
                const pinnedSection = document.getElementById(
                    "pinned-prayer-section",
                );
                const matchesListUl = document.getElementById(
                    "collected-matches-list",
                );
                const mailButton = document.getElementById(
                    "mail-collected-matches-button",
                );
                const snackbarContainer =
                    document.querySelector(".mdl-js-snackbar");

                // Pinned Prayer Display
                if (pinnedPrayerDetails) {
                    let pinnedName =
                        pinnedPrayerDetails.name ||
                        `Prayer ${pinnedPrayerDetails.version}`;
                    let metaText = `<strong>Pinned Prayer:</strong> ${pinnedName} (Ver: <a href="#prayer/${pinnedPrayerDetails.version}">${pinnedPrayerDetails.version}</a>, Lang: ${pinnedPrayerDetails.language}`;
                    if (pinnedPrayerDetails.phelps) {
                        metaText += `, Phelps: <a href="#prayercode/${pinnedPrayerDetails.phelps}">${pinnedPrayerDetails.phelps}</a>`;
                    }
                    metaText += `)`;

                    const pMeta = document.createElement("p");
                    pMeta.innerHTML = metaText;

                    const unpinButton = document.createElement("button");
                    unpinButton.className =
                        "mdl-button mdl-js-button mdl-button--icon mdl-button--colored";
                    unpinButton.innerHTML =
                        '<i class="material-icons">cancel</i>';
                    unpinButton.title = "Unpin Prayer & Clear All Matches";
                    unpinButton.onclick = unpinPrayer;

                    pinnedSection.innerHTML = ""; // Clear previous content
                    pinnedSection.appendChild(pMeta);
                    pMeta.appendChild(unpinButton); // Append button inside the metadata paragraph

                    if (pinnedPrayerDetails.text) {
                        const prayerTextDiv = document.createElement("div");
                        prayerTextDiv.id = "pinned-prayer-text-display";
                        prayerTextDiv.textContent = pinnedPrayerDetails.text;
                        pinnedSection.appendChild(prayerTextDiv);
                    }

                    if (typeof componentHandler !== "undefined") {
                        componentHandler.upgradeElement(unpinButton);
                    }
                } else {
                    pinnedSection.innerHTML =
                        '<p>No prayer is currently pinned. Navigate to a prayer and click "Pin this Prayer" to start.</p>';
                }

                // Collected Matches Display
                matchesListUl.innerHTML = ""; // Clear previous
                if (collectedMatchesForEmail.length > 0) {
                    collectedMatchesForEmail.forEach((matchData) => {
                        const li = document.createElement("li");
                        li.textContent = matchData.description;
                        matchesListUl.appendChild(li);
                    });
                    mailButton.disabled = false;
                } else {
                    const li = document.createElement("li");
                    li.textContent = "No matches collected yet.";
                    matchesListUl.appendChild(li);
                    mailButton.disabled = true;
                }
                if (
                    typeof componentHandler !== "undefined" &&
                    mailButton.classList.contains("mdl-js-button")
                ) {
                    if (mailButton.disabled) {
                        mailButton.setAttribute("disabled", "disabled");
                    } else {
                        mailButton.removeAttribute("disabled");
                    }
                    componentHandler.upgradeElement(mailButton);
                }
            }

            function pinPrayer(prayerData) {
                pinnedPrayerDetails = {
                    version: prayerData.version,
                    phelps: prayerData.phelps || null,
                    name: prayerData.name || `Prayer ${prayerData.version}`,
                    language: prayerData.language,
                    text: prayerData.text || "Text not available.", // Store prayer text
                };
                updatePrayerMatchingToolDisplay();
                handleRouteChange(); // Re-render current view to update action buttons
                const snackbarContainer =
                    document.querySelector(".mdl-js-snackbar");
                if (snackbarContainer && snackbarContainer.MaterialSnackbar) {
                    snackbarContainer.MaterialSnackbar.showSnackbar({
                        message: "Prayer pinned! Navigate to its match.",
                    });
                }
            }

            function unpinPrayer() {
                pinnedPrayerDetails = null;
                collectedMatchesForEmail = []; // Clear collected matches as well
                updatePrayerMatchingToolDisplay();
                handleRouteChange(); // Re-render current view to update action buttons
                const snackbarContainer =
                    document.querySelector(".mdl-js-snackbar");
                if (snackbarContainer && snackbarContainer.MaterialSnackbar) {
                    snackbarContainer.MaterialSnackbar.showSnackbar({
                        message: "Prayer unpinned and matches cleared.",
                    });
                }
            }

            function addCurrentPrayerAsMatch(currentPrayerData) {
                if (!pinnedPrayerDetails) {
                    alert("Error: No prayer is pinned to match against.");
                    return;
                }
                if (pinnedPrayerDetails.version === currentPrayerData.version) {
                    alert("Cannot match a prayer with itself.");
                    return;
                }

                const p1 = pinnedPrayerDetails; // Already has { version, phelps, name, language, text }
                const p2_for_match = {
                    // Extract only needed fields for consistency
                    version: currentPrayerData.version,
                    phelps: currentPrayerData.phelps || null,
                    name:
                        currentPrayerData.name ||
                        `Prayer ${currentPrayerData.version}`,
                    language: currentPrayerData.language,
                };

                let emailMatchDetail = "";
                if (p1.phelps && !p2_for_match.phelps) {
                    emailMatchDetail = `Pinned prayer (Phelps ${p1.phelps}, Version ${p1.version}) matches current prayer (Version ${p2_for_match.version}).`;
                } else if (!p1.phelps && p2_for_match.phelps) {
                    emailMatchDetail = `Pinned prayer (Version ${p1.version}) matches current prayer (Phelps ${p2_for_match.phelps}, Version ${p2_for_match.version}).`;
                } else if (!p1.phelps && !p2_for_match.phelps) {
                    emailMatchDetail = `Pinned prayer (Version ${p1.version}) matches current prayer (Version ${p2_for_match.version}).`;
                } else {
                    // Both have phelps (could be same or different)
                    emailMatchDetail = `Pinned prayer (Phelps ${p1.phelps}, Version ${p1.version}) matches current prayer (Phelps ${p2_for_match.phelps}, Version ${p2_for_match.version}).`;
                }

                collectedMatchesForEmail.push({
                    pinned: p1,
                    current: p2_for_match,
                    description: emailMatchDetail,
                });
                updatePrayerMatchingToolDisplay();

                const snackbarContainer =
                    document.querySelector(".mdl-js-snackbar");
                if (snackbarContainer && snackbarContainer.MaterialSnackbar) {
                    snackbarContainer.MaterialSnackbar.showSnackbar({
                        message: "Match added to list for emailing.",
                    });
                } else {
                    console.log("Match added to list for emailing.");
                }
            }

            function sendMatchesByEmail() {
                if (collectedMatchesForEmail.length === 0) {
                    alert("No matches to send.");
                    return;
                }

                const subject =
                    "holywritings.net: Prayer Matches and SQL Suggestions";
                const bodyLines = [
                    "Hello,",
                    "I've found the following prayer matches on holywritings.net:",
                    "",
                ];
                collectedMatchesForEmail.forEach((matchData, index) => {
                    bodyLines.push(`${index + 1}. ${matchData.description}`);
                });
                bodyLines.push("");
                bodyLines.push(
                    "Thank you for maintaining this wonderful resource!",
                );
                bodyLines.push(
                    `Base URL for reference: ${window.location.origin}${window.location.pathname}`,
                );
                bodyLines.push("");

                const sqlUpdateQueries = [];

                function uuidToBase36(uuid_string) {
                    if (!uuid_string || typeof uuid_string !== "string")
                        return "INVALID_UUID_INPUT";
                    const hexString = uuid_string.replace(/-/g, "");
                    try {
                        // Ensure it's a valid hex string for BigInt conversion
                        if (!/^[0-9a-fA-F]+$/.test(hexString)) {
                            console.error(
                                "Invalid characters in UUID hex string:",
                                hexString,
                            );
                            return "INVALID_HEX_IN_UUID";
                        }
                        return BigInt("0x" + hexString).toString(36);
                    } catch (e) {
                        console.error(
                            "Error converting UUID to Base36:",
                            uuid_string,
                            e,
                        );
                        // Provide a fallback that's still somewhat unique, or a fixed error string
                        // For simplicity, let's use a portion of the original UUID if conversion fails
                        return "CONV_ERR_" + hexString.substring(0, 8);
                    }
                }

                collectedMatchesForEmail.forEach((matchData) => {
                    const p1 = matchData.pinned; // Pinned prayer
                    const p2 = matchData.current; // Current prayer matched against pinned

                    if (p1.phelps && !p2.phelps) {
                        // Pinned has Phelps, current does not: Assign pinned's Phelps to current
                        sqlUpdateQueries.push(
                            `UPDATE writings SET phelps = '${p1.phelps}' WHERE version = '${p2.version}'; -- Auto-assign from pinned ${p1.version} (Phelps: ${p1.phelps}) to ${p2.version} (${p2.language})`,
                        );
                    } else if (!p1.phelps && p2.phelps) {
                        // Current has Phelps, pinned does not: Assign current's Phelps to pinned
                        sqlUpdateQueries.push(
                            `UPDATE writings SET phelps = '${p2.phelps}' WHERE version = '${p1.version}'; -- Auto-assign from current ${p2.version} (Phelps: ${p2.phelps}) to ${p1.version} (${p1.language})`,
                        );
                    } else if (!p1.phelps && !p2.phelps) {
                        // Neither has Phelps: Create a new temporary Phelps code and assign to both
                        const base36Version = uuidToBase36(p1.version);
                        const fakePhelps = `TODO${base36Version}`;

                        sqlUpdateQueries.push(
                            `UPDATE writings SET phelps = '${fakePhelps}' WHERE version = '${p1.version}'; -- Assign new temp Phelps: ${p1.version} (${p1.language}) linked with ${p2.version} (${p2.language}) using ${fakePhelps}`,
                        );
                        sqlUpdateQueries.push(
                            `UPDATE writings SET phelps = '${fakePhelps}' WHERE version = '${p2.version}'; -- Assign new temp Phelps: ${p2.version} (${p2.language}) linked with ${p1.version} (${p1.language}) using ${fakePhelps}`,
                        );
                    }
                    // If p1.phelps && p2.phelps && p1.phelps !== p2.phelps:
                    // This is a conflict. The matchData.description should already highlight this.
                    // No automatic SQL UPDATE is generated as per the prompt's focus.
                    // If p1.phelps && p2.phelps && p1.phelps === p2.phelps:
                    // Both have the same Phelps, no action needed.
                });

                if (sqlUpdateQueries.length > 0) {
                    bodyLines.push("--- Suggested SQL UPDATE Statements ---");
                    sqlUpdateQueries.forEach((q) => bodyLines.push(q));
                } else {
                    bodyLines.push(
                        "--- No SQL UPDATE Statements Suggested for these matches ---",
                    );
                }
                bodyLines.push("");

                // Remove the section for SELECT queries as per prompt
                // if (sqlSelectForReviewQueries.length > 0) { ... } else { ... }

                const mailBody = encodeURIComponent(bodyLines.join("\n"));
                const mailtoLink = `mailto:ikojba@gmail.com?subject=${encodeURIComponent(subject)}&body=${mailBody}`;

                const tempLink = document.createElement("a");
                tempLink.href = mailtoLink;
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);

                // Clear matches after attempting to send email
                collectedMatchesForEmail = [];
                updatePrayerMatchingToolDisplay();
            }

            // --- LocalStorage Cache Functions ---
            function cachePrayerText(prayerData) {
                if (
                    !prayerData ||
                    !prayerData.version ||
                    typeof prayerData.text === "undefined"
                ) {
                    console.warn(
                        "Attempted to cache invalid prayer data",
                        prayerData,
                    );
                    return;
                }
                try {
                    const key = `${LOCALSTORAGE_PRAYER_CACHE_PREFIX}${prayerData.version}`;
                    const dataToStore = {
                        version: prayerData.version,
                        text: prayerData.text,
                        name: prayerData.name || null,
                        language: prayerData.language || null,
                        phelps: prayerData.phelps || null,
                        link: prayerData.link || null, // Cache link too
                        source: prayerData.source || null, // Cache source
                        timestamp: Date.now(),
                    };
                    localStorage.setItem(key, JSON.stringify(dataToStore));
                } catch (e) {
                    console.error(
                        "Error caching prayer text to localStorage:",
                        e,
                    );
                }
            }

            function getCachedPrayerText(versionId) {
                try {
                    const key = `${LOCALSTORAGE_PRAYER_CACHE_PREFIX}${versionId}`;
                    const storedData = localStorage.getItem(key);
                    if (storedData) {
                        return JSON.parse(storedData);
                    }
                } catch (e) {
                    console.error(
                        "Error retrieving cached prayer text from localStorage:",
                        e,
                    );
                }
                return null;
            }

            function getAllCachedPrayers() {
                const cachedPrayers = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (
                        key &&
                        key.startsWith(LOCALSTORAGE_PRAYER_CACHE_PREFIX)
                    ) {
                        try {
                            const item = JSON.parse(localStorage.getItem(key));
                            if (
                                item &&
                                item.version &&
                                typeof item.text !== "undefined"
                            ) {
                                cachedPrayers.push(item);
                            }
                        } catch (e) {
                            console.warn(
                                "Error parsing a cached prayer from localStorage:",
                                key,
                                e,
                            );
                        }
                    }
                }
                return cachedPrayers;
            }
            // --- End LocalStorage Cache Functions ---

            async function executeQuery(sql) {
                try {
                    const response = await fetch(
                        DOLTHUB_API_BASE_URL + encodeURIComponent(sql),
                    );
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    return data.rows || [];
                } catch (error) {
                    console.error("Error executing query:", error);
                    contentDiv.innerHTML = `<p>Error loading data: ${error.message}. Please try again later.</p>`;
                    return [];
                }
            }

            function getAuthorFromPhelps(phelpsCode) {
                if (
                    !phelpsCode ||
                    typeof phelpsCode !== "string" ||
                    phelpsCode.length < 2
                ) {
                    return null;
                }
                const prefix = phelpsCode.substring(0, 2).toUpperCase();
                switch (prefix) {
                    case "AB":
                        return "`Abdu'l-Bahá";
                    case "BH":
                        return "Bahá'u'lláh";
                    case "BB":
                        return "The Báb";
                    default:
                        return null;
                }
            }

            // --- Prayer Card Generation ---
            function createPrayerCardHtml(prayerData, allPhelpsDetails = {}) {
                // prayerData expected: { version, name, language, phelps, opening_text, link (source url) }
                // allPhelpsDetails: { phelps1: [{version, language, name, link}, ...], ... }
                const {
                    version,
                    name,
                    language = "N/A",
                    phelps,
                    opening_text,
                    link, // Source URL for this specific prayer version on the card
                } = prayerData;

                let displayTitle;
                if (name) {
                    displayTitle = name;
                } else if (phelps) {
                    displayTitle = `Phelps: ${phelps}`;
                } else {
                    displayTitle = `Prayer ${version}`;
                }

                const cardLinkHref = phelps
                    ? `#prayercode/${phelps}/${language}`
                    : `#prayer/${version}`;

                const previewSnippet =
                    opening_text || "No text preview available.";

                let otherVersionsHtml = "";
                if (phelps && allPhelpsDetails && allPhelpsDetails[phelps]) {
                    const allVersionsForThisPhelps = allPhelpsDetails[phelps];
                    const currentVersionId = version;
                    const currentLanguage = language;

                    const groupedByLanguage = {};
                    allVersionsForThisPhelps.forEach((v) => {
                        if (v.version === currentVersionId) return; // Skip self
                        if (!groupedByLanguage[v.language]) {
                            groupedByLanguage[v.language] = [];
                        }
                        groupedByLanguage[v.language].push(v);
                    });

                    let otherLanguageLinks = [];
                    let sameLanguageAltVersions = [];

                    // Sort language codes for consistent display
                    const sortedLangCodes =
                        Object.keys(groupedByLanguage).sort();

                    for (const langCode of sortedLangCodes) {
                        if (langCode !== currentLanguage) {
                            // Create one link per other language
                            otherLanguageLinks.push(`
                                <li class="favorite-prayer-card-translations-item">
                                    <a href="#prayercode/${phelps}/${langCode}">${langCode.toUpperCase()}</a>
                                </li>`);
                        } else {
                            // Versions in the same language as the card
                            groupedByLanguage[langCode].forEach(
                                (altVersion) => {
                                    sameLanguageAltVersions.push(`
                                    <li>
                                        <a href="#prayer/${altVersion.version}">
                                            ${altVersion.name || "Version " + altVersion.version}
                                            ${altVersion.link ? `(${getDomain(altVersion.link)})` : ""}
                                        </a>
                                    </li>`);
                                },
                            );
                        }
                    }

                    if (
                        otherLanguageLinks.length > 0 ||
                        sameLanguageAltVersions.length > 0
                    ) {
                        otherVersionsHtml += `<div class="favorite-prayer-card-translations">`;
                        if (otherLanguageLinks.length > 0) {
                            otherVersionsHtml += `
                                <h5>Translations:</h5>
                                <ul class="favorite-prayer-card-translations-list">${otherLanguageLinks.join("")}</ul>`;
                        }
                        if (sameLanguageAltVersions.length > 0) {
                            otherVersionsHtml += `
                                <h5 style="margin-top: ${otherLanguageLinks.length > 0 ? "10px" : "0"};">Other versions in ${currentLanguage.toUpperCase()}:</h5>
                                <ul class="other-versions-in-lang-list">${sameLanguageAltVersions.join("")}</ul>`;
                        }
                        otherVersionsHtml += `</div>`;
                    }
                }

                return `
                <div class="favorite-prayer-card">
                    <div> <!-- Content wrapper -->
                        <div class="favorite-prayer-card-header">
                            <a href="${cardLinkHref}">${displayTitle}</a>
                        </div>
                        <p class="favorite-prayer-card-preview">${previewSnippet}</p>
                        <div class="favorite-prayer-card-meta">
                            <span>Lang: ${language.toUpperCase()}</span>
                            ${phelps ? `<span class="phelps-code">Phelps: <a href="#prayercode/${phelps}">${phelps}</a></span>` : ""}
                            ${link ? `<span>Source: <a href="${link}" target="_blank">${getDomain(link) || "Link"}</a></span>` : ""}
                        </div>
                    </div>
                    ${otherVersionsHtml}
                </div>`;
            }

            function updateHeaderNavigation(links = []) {
                if (!prayerLanguageNav) return;
                prayerLanguageNav.innerHTML = "";

                if (links.length === 0) {
                    const loadingLink = document.createElement("span");
                    loadingLink.className = "mdl-navigation__link";
                    loadingLink.textContent = "N/A";
                    loadingLink.style.color = "rgba(255,255,255,0.7)";
                    prayerLanguageNav.appendChild(loadingLink);
                    return;
                }

                if (links.length > MAX_DIRECT_LINKS_IN_HEADER) {
                    const buttonId = "languages-menu-button";
                    let menuButton = document.getElementById(buttonId);
                    if (!menuButton) {
                        menuButton = document.createElement("button");
                        menuButton.id = buttonId;
                        menuButton.className =
                            "mdl-button mdl-js-button mdl-button--icon";
                        const icon = document.createElement("i");
                        icon.className = "material-icons";
                        icon.textContent = "language";
                        menuButton.appendChild(icon);
                        prayerLanguageNav.appendChild(menuButton);
                    }

                    const existingMenuUl =
                        prayerLanguageNav.querySelector(".mdl-menu");
                    if (existingMenuUl) existingMenuUl.remove();

                    const menuUl = document.createElement("ul");
                    menuUl.className =
                        "mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect";
                    menuUl.setAttribute("for", buttonId);

                    links.forEach((linkInfo) => {
                        const menuItemLi = document.createElement("li");
                        menuItemLi.className = "mdl-menu__item";
                        const linkA = document.createElement("a");
                        linkA.href = linkInfo.href;
                        linkA.textContent = linkInfo.text;
                        linkA.style.textDecoration = "none";
                        linkA.style.color = "inherit";
                        linkA.style.display = "block";
                        if (linkInfo.isActive) {
                            // Simple way to indicate active
                            linkA.style.fontWeight = "bold";
                        }
                        menuItemLi.appendChild(linkA);
                        menuUl.appendChild(menuItemLi);
                    });
                    prayerLanguageNav.appendChild(menuUl);

                    if (typeof componentHandler !== "undefined") {
                        if (menuButton.MaterialButton)
                            componentHandler.upgradeElement(menuButton);
                        if (menuUl.MaterialMenu)
                            componentHandler.upgradeElement(menuUl);
                        else componentHandler.upgradeDom();
                    }
                } else {
                    links.forEach((linkInfo) => {
                        const link = document.createElement("a");
                        link.className = "mdl-navigation__link";
                        link.href = linkInfo.href;
                        link.textContent = linkInfo.text;
                        if (linkInfo.isActive) {
                            link.style.fontWeight = "bold";
                            link.style.textDecoration = "underline";
                        }
                        prayerLanguageNav.appendChild(link);
                    });
                }
            }

            function updateDrawerLanguageNavigation(links = []) {
                if (!drawerPrayerLanguageNav) return;
                drawerPrayerLanguageNav.innerHTML = "";

                if (links.length === 0) {
                    const noLinksMsg = document.createElement("span");
                    noLinksMsg.className = "mdl-navigation__link";
                    noLinksMsg.textContent = "Languages N/A";
                    noLinksMsg.style.fontStyle = "italic";
                    noLinksMsg.style.color = "#757575";
                    drawerPrayerLanguageNav.appendChild(noLinksMsg);
                    return;
                }

                links.forEach((linkInfo) => {
                    const link = document.createElement("a");
                    link.className = "mdl-navigation__link";
                    link.href = linkInfo.href;
                    link.textContent = linkInfo.text;
                    if (linkInfo.isActive) {
                        link.style.fontWeight = "bold";
                    }
                    link.addEventListener("click", () => {
                        const layout = document.querySelector(".mdl-layout");
                        if (
                            layout &&
                            layout.MaterialLayout &&
                            layout.MaterialLayout.drawer_
                        ) {
                            layout.MaterialLayout.toggleDrawer();
                        }
                    });
                    drawerPrayerLanguageNav.appendChild(link);
                });
            }

            async function renderPrayer(
                versionId,
                phelpsCodeForNav = null,
                activeLangForNav = null,
            ) {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                // Clear navs initially, they will be repopulated
                updateHeaderNavigation([]);
                updateDrawerLanguageNavigation([]);

                const sql = `SELECT version, text, language, phelps, name, source, link FROM writings WHERE version = '${versionId}' LIMIT 1`;
                const rows = await executeQuery(sql);

                if (rows.length === 0) {
                    const debugQueryUrl = `${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(sql)}`;
                    contentDiv.innerHTML = `
                        <p>Prayer with ID ${versionId} not found.</p>
                        <p>Query used:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${sql}</pre>
                        <p><a href="${debugQueryUrl}" target="_blank">Debug this query on DoltHub</a></p>
                    `;
                    return;
                }

                const prayer = rows[0];

                cachePrayerText({
                    // Ensure all relevant fields are passed for caching
                    version: prayer.version,
                    text: prayer.text,
                    name: prayer.name,
                    language: prayer.language,
                    phelps: prayer.phelps,
                    link: prayer.link,
                    source: prayer.source,
                });

                const authorName = getAuthorFromPhelps(prayer.phelps);
                let prayerTitle =
                    prayer.name ||
                    (prayer.phelps ? `Phelps: ${prayer.phelps}` : null) ||
                    (prayer.text
                        ? prayer.text.substring(0, 50) + "..."
                        : `Prayer ${prayer.version}`);

                const phelpsLinkHtml = prayer.phelps
                    ? `<a href="#prayercode/${prayer.phelps}">${prayer.phelps}</a>`
                    : "";

                let html = `
                    <header>
                        <h2>
                            <span id="category">Prayer</span>
                            <span id="blocktitle">${prayerTitle}</span>
                        </h2>
                    </header>
                    <div class="scripture">
                        <div class="prayer" style="white-space: pre-wrap;">${prayer.text || "No text available."}</div>
                        ${authorName ? `<div class="author">${authorName}</div>` : ""}
                        ${prayer.source ? `<div style="font-size: 0.8em; margin-left: 2em; margin-top: 0.5em; font-style: italic;">Source: ${prayer.source} ${prayer.link ? `(<a href="${prayer.link}" target="_blank">${getDomain(prayer.link) || "link"}</a>)` : ""}</div>` : ""}
                        ${prayer.phelps ? `<div style="font-size: 0.7em; margin-left: 2em; margin-top: 0.3em; color: #555;">Phelps ID: ${phelpsLinkHtml} (Lang: ${prayer.language.toUpperCase()})</div>` : ""}
                        <div style="font-size: 0.7em; margin-left: 2em; margin-top: 0.3em; color: #555;">Version ID: ${prayer.version}</div>
                    </div>
                `;
                contentDiv.innerHTML = html;

                const favoriteButton = document.createElement("button");
                favoriteButton.className =
                    "mdl-button mdl-js-button mdl-button--icon favorite-toggle-button";
                const favoriteIcon = document.createElement("i");
                favoriteIcon.className = "material-icons";

                if (isPrayerFavorite(prayer.version)) {
                    favoriteButton.classList.add("is-favorite");
                    favoriteIcon.textContent = "star";
                    favoriteButton.title = "Remove from Favorites";
                } else {
                    favoriteIcon.textContent = "star_border";
                    favoriteButton.title = "Add to Favorites";
                }
                favoriteButton.appendChild(favoriteIcon);
                favoriteButton.onclick = () => toggleFavoritePrayer(prayer);
                contentDiv.appendChild(favoriteButton);
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeElement(favoriteButton);
                }

                const actionsDiv = document.createElement("div");
                actionsDiv.className = "prayer-actions";
                // Pin/Match buttons logic
                if (pinnedPrayerDetails) {
                    if (pinnedPrayerDetails.version !== prayer.version) {
                        const addMatchButton = document.createElement("button");
                        addMatchButton.className =
                            "mdl-button mdl-js-button mdl-button--raised mdl-button--accent";
                        const pinnedNameSnippet = (
                            pinnedPrayerDetails.name ||
                            `Version ${pinnedPrayerDetails.version}`
                        ).substring(0, 25);
                        addMatchButton.innerHTML = `<i class="material-icons">playlist_add_check</i> Add Match for Pinned: ${pinnedNameSnippet}${pinnedNameSnippet.length === 25 ? "..." : ""}`;
                        addMatchButton.onclick = () =>
                            addCurrentPrayerAsMatch(prayer);
                        actionsDiv.appendChild(addMatchButton);
                        if (typeof componentHandler !== "undefined")
                            componentHandler.upgradeElement(addMatchButton);
                    } else {
                        const p = document.createElement("p");
                        p.innerHTML =
                            "<em>This prayer is currently pinned.</em>";
                        actionsDiv.appendChild(p);
                    }
                } else {
                    const pinButton = document.createElement("button");
                    pinButton.className =
                        "mdl-button mdl-js-button mdl-button--raised mdl-button--colored";
                    pinButton.innerHTML =
                        '<i class="material-icons">push_pin</i> Pin this Prayer';
                    pinButton.onclick = () => pinPrayer(prayer);
                    actionsDiv.appendChild(pinButton);
                    if (typeof componentHandler !== "undefined")
                        componentHandler.upgradeElement(pinButton);
                }
                contentDiv.appendChild(actionsDiv);

                // Navigation links for other languages/versions of the same Phelps code
                const finalPhelpsCode = phelpsCodeForNav || prayer.phelps;
                const finalActiveLang = activeLangForNav || prayer.language;

                if (finalPhelpsCode) {
                    const transSql = `SELECT DISTINCT language FROM writings WHERE phelps = '${finalPhelpsCode}' AND phelps IS NOT NULL AND phelps != '' ORDER BY language`;
                    const distinctLangs = await executeQuery(transSql);

                    const navLinks = distinctLangs.map((langRow) => ({
                        text: langRow.language.toUpperCase(),
                        href: `#prayercode/${finalPhelpsCode}/${langRow.language}`,
                        isActive: langRow.language === finalActiveLang,
                    }));

                    updateHeaderNavigation(navLinks);
                    updateDrawerLanguageNavigation(navLinks);
                } else {
                    // No Phelps code, so just show current language (not really a "translation list")
                    const singleLink = [
                        {
                            text: prayer.language.toUpperCase(),
                            href: `#prayer/${prayer.version}`,
                            isActive: true,
                        },
                    ];
                    updateHeaderNavigation(singleLink);
                    updateDrawerLanguageNavigation(singleLink);
                }
            }

            async function renderPrayersForLanguage(
                langCode,
                page = 1,
                showOnlyUnmatched = false,
            ) {
                currentPageByLanguage[langCode] = { page, showOnlyUnmatched };
                const offset = (page - 1) * ITEMS_PER_PAGE;
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]); // Clear nav
                updateDrawerLanguageNavigation([]); // Clear nav

                const languageDisplayName = langCode.toUpperCase();
                let filterCondition = "";
                if (showOnlyUnmatched) {
                    filterCondition = " AND (phelps IS NULL OR phelps = '')";
                }

                const metadataSql = `SELECT version, name, language, phelps, link FROM writings WHERE language = '${langCode}'${filterCondition} ORDER BY name, version LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}`;
                const prayersMetadata = await executeQuery(metadataSql);

                const countSql = `SELECT COUNT(*) as total FROM writings WHERE language = '${langCode}'${filterCondition}`;
                const countResult = await executeQuery(countSql);
                const totalPrayers =
                    countResult.length > 0 ? countResult[0].total : 0;
                const totalPages = Math.ceil(totalPrayers / ITEMS_PER_PAGE);

                if (prayersMetadata.length === 0 && page === 1) {
                    // ... (no change to this block for now)
                    const filterSwitchId = `filter-unmatched-${langCode}`;
                    const filterSwitchHtml = `
                        <div class="filter-switch-container">
                            <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="${filterSwitchId}">
                                <input type="checkbox" id="${filterSwitchId}" class="mdl-switch__input"
                                       onchange="setLanguageView('${langCode}', 1, this.checked)"
                                       ${showOnlyUnmatched ? "checked" : ""}>
                                <span class="mdl-switch__label">Show only prayers without Phelps code</span>
                            </label>
                        </div>`;
                    contentDiv.innerHTML = `
                        ${filterSwitchHtml}
                        <p>No prayers found for language: ${languageDisplayName} ${showOnlyUnmatched ? " (matching filter)" : ""}.</p>
                        <p>Query used for metadata:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${metadataSql}</pre>
                        <p><a href="${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(metadataSql)}" target="_blank">Debug metadata query on DoltHub</a></p>
                        <p>Count query used:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${countSql}</pre>
                        <p><a href="${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(countSql)}" target="_blank">Debug count query on DoltHub</a></p>
                    `;
                    if (typeof componentHandler !== "undefined")
                        componentHandler.upgradeDom();
                    return;
                }
                if (prayersMetadata.length === 0 && page > 1) {
                    setLanguageView(
                        langCode,
                        Math.max(1, totalPages),
                        showOnlyUnmatched,
                    );
                    return;
                }

                const prayersForDisplay = [];
                for (const pMeta of prayersMetadata) {
                    let full_text_for_preview = null;
                    const cached = getCachedPrayerText(pMeta.version);
                    if (cached) {
                        full_text_for_preview = cached.text;
                        pMeta.name = cached.name || pMeta.name; // Use cached if available
                        pMeta.phelps = cached.phelps || pMeta.phelps;
                        pMeta.link = cached.link || pMeta.link;
                    } else {
                        const textSql = `SELECT text FROM writings WHERE version = '${pMeta.version}' LIMIT 1`;
                        const textRows = await executeQuery(textSql);
                        if (textRows.length > 0 && textRows[0].text) {
                            full_text_for_preview = textRows[0].text;
                            cachePrayerText({
                                // Cache all relevant fields
                                version: pMeta.version,
                                text: full_text_for_preview,
                                name: pMeta.name,
                                language: pMeta.language,
                                phelps: pMeta.phelps,
                                link: pMeta.link,
                            });
                        }
                    }
                    const opening_text_for_card = full_text_for_preview
                        ? full_text_for_preview.substring(
                              0,
                              MAX_PREVIEW_LENGTH,
                          ) +
                          (full_text_for_preview.length > MAX_PREVIEW_LENGTH
                              ? "..."
                              : "")
                        : "No text preview available.";
                    prayersForDisplay.push({
                        ...pMeta,
                        opening_text: opening_text_for_card,
                    });
                }

                let allPhelpsDetailsForCards = {};
                const phelpsCodesInList = [
                    ...new Set(
                        prayersForDisplay
                            .filter((p) => p.phelps)
                            .map((p) => p.phelps),
                    ),
                ];
                if (phelpsCodesInList.length > 0) {
                    const phelpsInClause = phelpsCodesInList
                        .map((p) => `'${p.replace(/'/g, "''")}'`)
                        .join(",");
                    const translationsSql = `SELECT version, language, phelps, name, link FROM writings WHERE phelps IN (${phelpsInClause})`;
                    try {
                        const translationRows =
                            await executeQuery(translationsSql);
                        translationRows.forEach((row) => {
                            if (!allPhelpsDetailsForCards[row.phelps])
                                allPhelpsDetailsForCards[row.phelps] = [];
                            allPhelpsDetailsForCards[row.phelps].push({
                                version: row.version,
                                language: row.language,
                                name: row.name,
                                link: row.link,
                            });
                        });
                    } catch (e) {
                        console.error(
                            "Failed to fetch details for phelps codes:",
                            e,
                        );
                    }
                }

                const listCardsHtmlArray = prayersForDisplay.map((pData) => {
                    return createPrayerCardHtml(
                        pData,
                        allPhelpsDetailsForCards,
                    );
                });
                const listHtml = `<div class="favorite-prayer-grid">${listCardsHtmlArray.join("")}</div>`;

                let paginationHtml = "";
                // ... (pagination logic unchanged)
                if (totalPages > 1) {
                    paginationHtml = '<div class="pagination">';
                    if (page > 1)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="setLanguageView('${langCode}', ${page - 1}, ${showOnlyUnmatched})">Previous</button>`;
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="setLanguageView('${langCode}', ${page + 1}, ${showOnlyUnmatched})">Next</button>`;
                    paginationHtml += "</div>";
                }

                const filterSwitchId = `filter-unmatched-${langCode}`;
                // ... (filter switch HTML unchanged)
                const filterSwitchHtml = `
                    <div class="filter-switch-container">
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="${filterSwitchId}">
                            <input type="checkbox" id="${filterSwitchId}" class="mdl-switch__input"
                                   onchange="setLanguageView('${langCode}', 1, this.checked)"
                                   ${showOnlyUnmatched ? "checked" : ""}>
                            <span class="mdl-switch__label">Show only prayers without Phelps code</span>
                        </label>
                    </div>`;

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Language: ${languageDisplayName} (Page ${page})${showOnlyUnmatched ? " - Unmatched" : ""}</span>
                        </h2>
                    </header>
                    ${filterSwitchHtml}
                    ${listHtml}
                    ${paginationHtml}
                `;
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
            }

            async function renderPrayerCodeView(phelpsCode, page = 1) {
                currentPageByPhelpsCode[phelpsCode] = page;
                const offset = (page - 1) * ITEMS_PER_PAGE;

                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                // Nav will be set by resolveAndRenderPrayerByPhelpsAndLang if used, or by renderPrayer, or here for the list.
                // For a list of different languages for one phelps, the nav makes sense to show those languages.
                const phelpsLangsSql = `SELECT DISTINCT language FROM writings WHERE phelps = '${phelpsCode.replace(/'/g, "''")}' ORDER BY language`;
                const distinctLangs = await executeQuery(phelpsLangsSql);
                const navLinks = distinctLangs.map((langRow) => ({
                    text: langRow.language.toUpperCase(),
                    href: `#prayercode/${phelpsCode}/${langRow.language}`,
                    isActive: false, // No specific active lang for the general phelps list
                }));
                updateHeaderNavigation(navLinks);
                updateDrawerLanguageNavigation(navLinks);

                const metadataSql = `SELECT version, name, language, text, phelps, link FROM writings WHERE phelps = '${phelpsCode.replace(/'/g, "''")}' AND phelps IS NOT NULL AND phelps != '' ORDER BY language, name LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}`;
                const prayersMetadata = await executeQuery(metadataSql);

                const countSql = `SELECT COUNT(*) as total FROM writings WHERE phelps = '${phelpsCode.replace(/'/g, "''")}' AND phelps IS NOT NULL AND phelps != ''`;
                const countResult = await executeQuery(countSql);
                const totalPrayers =
                    countResult.length > 0 ? countResult[0].total : 0;
                const totalPages = Math.ceil(totalPrayers / ITEMS_PER_PAGE);

                if (prayersMetadata.length === 0 && page === 1) {
                    // ... (no change)
                    const debugQueryUrl = `${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(metadataSql)}`;
                    contentDiv.innerHTML = `
                        <p>No prayer versions found for Phelps Code: ${phelpsCode}.</p>
                        <p>Query used:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${metadataSql}</pre>
                        <p><a href="${debugQueryUrl}" target="_blank">Debug this query on DoltHub</a></p>`;
                    return;
                }
                if (prayersMetadata.length === 0 && page > 1) {
                    renderPrayerCodeView(phelpsCode, Math.max(1, totalPages));
                    return;
                }

                const prayersForDisplay = prayersMetadata.map((p) => {
                    let full_text_for_preview = p.text; // Text is fetched directly
                    if (!getCachedPrayerText(p.version) && p.text) {
                        // Cache if not already and text exists
                        cachePrayerText({
                            version: p.version,
                            text: p.text,
                            name: p.name,
                            language: p.language,
                            phelps: p.phelps,
                            link: p.link,
                        });
                    } else if (!p.text) {
                        // If text wasn't in direct query (e.g. if we remove it later for perf)
                        const cached = getCachedPrayerText(p.version);
                        if (cached && cached.text)
                            full_text_for_preview = cached.text;
                    }

                    const opening_text_for_card = full_text_for_preview
                        ? full_text_for_preview.substring(
                              0,
                              MAX_PREVIEW_LENGTH,
                          ) +
                          (full_text_for_preview.length > MAX_PREVIEW_LENGTH
                              ? "..."
                              : "")
                        : "No text preview available.";
                    return { ...p, opening_text: opening_text_for_card };
                });

                let allPhelpsDetailsForCards = {};
                // For prayer code view, all cards share the same Phelps code.
                // We need all versions for this specific Phelps code.
                // prayersMetadata already contains these for the current page. To get all, we'd need another query or use prayersMetadata if it's all of them.
                // For simplicity on card display, we can reuse prayersMetadata if it's comprehensive enough or make a specific call.
                // Since prayersMetadata is paginated, it's not all versions. So we need to fetch all for this phelps.
                if (phelpsCode) {
                    const allVersionsSql = `SELECT version, language, phelps, name, link FROM writings WHERE phelps = '${phelpsCode.replace(/'/g, "''")}'`;
                    const allVersionRows = await executeQuery(allVersionsSql);
                    if (allVersionRows.length > 0) {
                        allPhelpsDetailsForCards[phelpsCode] =
                            allVersionRows.map((r) => ({ ...r }));
                    }
                }

                const listCardsHtmlArray = prayersForDisplay.map((pData) => {
                    return createPrayerCardHtml(
                        pData,
                        allPhelpsDetailsForCards,
                    );
                });
                const listHtml = `<div class="favorite-prayer-grid">${listCardsHtmlArray.join("")}</div>`;

                let paginationHtml = "";
                // ... (pagination logic unchanged)
                if (totalPages > 1) {
                    paginationHtml = '<div class="pagination">';
                    if (page > 1)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayerCodeView('${phelpsCode}', ${page - 1})">Previous</button>`;
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayerCodeView('${phelpsCode}', ${page + 1})">Next</button>`;
                    paginationHtml += "</div>";
                }

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayer Code</span>
                            <span id="blocktitle">${phelpsCode} (Page ${page}) - All Languages</span>
                        </h2>
                    </header>
                    ${listHtml}
                    ${paginationHtml}
                `;
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
            }

            async function resolveAndRenderPrayerByPhelpsAndLang(
                phelpsCode,
                targetLanguageCode,
            ) {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();

                const sql = `SELECT version, text, language, phelps, name, source, link FROM writings WHERE phelps = '${phelpsCode.replace(/'/g, "''")}' AND language = '${targetLanguageCode.replace(/'/g, "''")}' ORDER BY LENGTH(text) DESC, name`;
                const prayerVersions = await executeQuery(sql);

                if (prayerVersions.length === 0) {
                    contentDiv.innerHTML = `<p>No prayers found for Phelps Code ${phelpsCode} in language ${targetLanguageCode.toUpperCase()}.</p>`;
                    // Attempt to populate nav with other languages for this Phelps code
                    const transSql = `SELECT DISTINCT language FROM writings WHERE phelps = '${phelpsCode.replace(/'/g, "''")}' ORDER BY language`;
                    const distinctLangs = await executeQuery(transSql);
                    const navLinks = distinctLangs.map((langRow) => ({
                        text: langRow.language.toUpperCase(),
                        href: `#prayercode/${phelpsCode}/${langRow.language}`,
                        isActive: false, // None active as current target failed
                    }));
                    updateHeaderNavigation(navLinks);
                    updateDrawerLanguageNavigation(navLinks);
                    return;
                }

                const primaryPrayer = prayerVersions[0]; // Longest text first due to ORDER BY
                await renderPrayer(
                    primaryPrayer.version,
                    phelpsCode,
                    targetLanguageCode,
                ); // Pass phelps and lang for nav highlighting

                // If there are other versions for the same phelps/lang, list them below the main prayer
                if (prayerVersions.length > 1) {
                    const otherVersionsDiv = document.createElement("div");
                    otherVersionsDiv.style.marginTop = "20px";
                    otherVersionsDiv.style.paddingTop = "15px";
                    otherVersionsDiv.style.borderTop = "1px solid #eee";

                    let listHtml = `<h5>Other versions in ${targetLanguageCode.toUpperCase()} for ${phelpsCode}:</h5><ul class="other-versions-in-lang-list">`;
                    prayerVersions.slice(1).forEach((altVersion) => {
                        const displayName =
                            altVersion.name || `Version ${altVersion.version}`;
                        const domain = altVersion.link
                            ? `(${getDomain(altVersion.link)})`
                            : "";
                        listHtml += `<li><a href="#prayer/${altVersion.version}">${displayName} ${domain}</a></li>`;
                    });
                    listHtml += `</ul>`;
                    otherVersionsDiv.innerHTML = listHtml;
                    contentDiv.appendChild(otherVersionsDiv);
                    if (typeof componentHandler !== "undefined")
                        componentHandler.upgradeDom(); // For any new MDL elements
                }
            }

            async function renderLanguageList() {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]);
                updateDrawerLanguageNavigation([]);

                currentPageByLanguage = {};
                currentPageBySearchTerm = {};
                currentPageByPhelpsCode = {};
                currentPageByPhelpsLangCode = {};

                let favoritesDisplayHtml = "";
                if (favoritePrayers.length > 0) {
                    favoritesDisplayHtml += `<div id="favorite-prayers-section"><h3>⭐ Your Favorite Prayers</h3>`;

                    const phelpsCodesToFetchForFavs = [
                        ...new Set(
                            favoritePrayers
                                .filter((fp) => fp.phelps)
                                .map((fp) => fp.phelps),
                        ),
                    ];
                    let allPhelpsDetailsForFavCards = {};

                    if (phelpsCodesToFetchForFavs.length > 0) {
                        const phelpsInClause = phelpsCodesToFetchForFavs
                            .map((p) => `'${p.replace(/'/g, "''")}'`)
                            .join(",");
                        const favTranslationsSql = `SELECT version, language, phelps, name, link FROM writings WHERE phelps IN (${phelpsInClause})`;
                        try {
                            const translationRows =
                                await executeQuery(favTranslationsSql);
                            translationRows.forEach((row) => {
                                if (!allPhelpsDetailsForFavCards[row.phelps])
                                    allPhelpsDetailsForFavCards[row.phelps] =
                                        [];
                                allPhelpsDetailsForFavCards[row.phelps].push({
                                    ...row,
                                });
                            });
                        } catch (e) {
                            console.error(
                                "Failed to fetch details for favorite phelps codes:",
                                e,
                            );
                        }
                    }

                    const favoriteCardsHtmlArray = [];
                    for (const fp of favoritePrayers) {
                        const cached = getCachedPrayerText(fp.version);
                        let textForCardPreview = "Preview not available.";
                        let nameForCard =
                            fp.name || (cached ? cached.name : null);
                        let langForCard =
                            fp.language || (cached ? cached.language : "N/A");
                        let phelpsForCard =
                            fp.phelps || (cached ? cached.phelps : null);
                        let linkForCard = cached ? cached.link : null; // Link specific to this version

                        if (cached && cached.text) {
                            textForCardPreview =
                                cached.text.substring(0, MAX_PREVIEW_LENGTH) +
                                (cached.text.length > MAX_PREVIEW_LENGTH
                                    ? "..."
                                    : "");
                        } else if (fp.version) {
                            // If no cached text, try to fetch it just for preview
                            // This could be slow if many favorites are not cached. Consider skipping or limiting.
                            // For now, let's assume cache hit or "Preview not available" is acceptable.
                        }

                        const prayerDataForCard = {
                            version: fp.version,
                            name: nameForCard,
                            language: langForCard,
                            phelps: phelpsForCard,
                            opening_text: textForCardPreview,
                            link: linkForCard,
                        };
                        favoriteCardsHtmlArray.push(
                            createPrayerCardHtml(
                                prayerDataForCard,
                                allPhelpsDetailsForFavCards,
                            ),
                        );
                    }

                    favoritesDisplayHtml += `<div class="favorite-prayer-grid">${favoriteCardsHtmlArray.join("")}</div>`;
                    favoritesDisplayHtml += `</div>`;
                } else {
                    favoritesDisplayHtml += `<div id="favorite-prayers-section" style="text-align: center; padding: 10px 0; margin-bottom:10px;">
                                             <p>You haven't favorited any prayers yet. <br/>Click the <i class="material-icons" style="vertical-align: bottom; font-size: 1.2em;">star_border</i> icon on a prayer's page to add it here!</p>
                                           </div>`;
                }

                const sql = `
                    SELECT
                        w.language,
                        (
                            SELECT COUNT(DISTINCT sub.phelps)
                            FROM writings sub
                            WHERE sub.language = w.language AND sub.phelps IS NOT NULL AND sub.phelps != ''
                        ) AS phelps_covered_count,
                        (
                            SELECT COUNT(DISTINCT CASE WHEN sub.phelps IS NOT NULL AND sub.phelps != '' THEN NULL ELSE sub.version END)
                            FROM writings sub
                            WHERE sub.language = w.language
                        ) AS versions_without_phelps_count
                    FROM writings w
                    WHERE w.language IS NOT NULL AND w.language != ''
                    GROUP BY w.language
                    ORDER BY w.language;
                `;
                const languagesWithStats = await executeQuery(sql);

                if (
                    languagesWithStats.length === 0 &&
                    favoritePrayers.length === 0
                ) {
                    // ... (no change)
                    const debugQueryUrl = `${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(sql)}`;
                    contentDiv.innerHTML =
                        favoritesDisplayHtml +
                        `
                        <p>No languages found in the database.</p>
                        <p>Query used:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${sql}</pre>
                        <p><a href="${debugQueryUrl}" target="_blank">Debug this query on DoltHub</a></p>
                    `;
                    return;
                }

                let languageListHtml = "";
                if (languagesWithStats.length > 0) {
                    languageListHtml = languagesWithStats
                        .map((langData) => {
                            const langCode = langData.language;
                            const phelpsCount =
                                parseInt(langData.phelps_covered_count, 10) ||
                                0;
                            const nonPhelpsCount =
                                parseInt(
                                    langData.versions_without_phelps_count,
                                    10,
                                ) || 0;
                            const totalConceptualPrayers =
                                phelpsCount + nonPhelpsCount;

                            let buttonClass =
                                "mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect";
                            if (totalConceptualPrayers > 0) {
                                const coverageRatio =
                                    phelpsCount / totalConceptualPrayers;
                                if (coverageRatio === 1) {
                                    buttonClass += " lang-button-green";
                                } else if (coverageRatio > 0.5) {
                                    buttonClass += " lang-button-yellow";
                                }
                            }

                            return `<button class="${buttonClass}" onclick="setLanguageView('${langCode}', 1, false)">
                                        ${langCode.toUpperCase()} (${phelpsCount}/${totalConceptualPrayers})
                                    </button>`;
                        })
                        .join("\n");
                }

                contentDiv.innerHTML =
                    favoritesDisplayHtml +
                    `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Available Languages</span>
                        </h2>
                    </header>
                    <div class="language-buttons-container">${languageListHtml}</div>
                    <p style="text-align:center; font-size:0.9em; color: #555; margin-top:10px;">
                        Counts are (Unique Phelps Codes / Total Unique Prayers). Click a language to browse.
                    </p>
                `;

                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
            }

            async function renderSearchResults(searchTerm, page = 1) {
                currentPageBySearchTerm[searchTerm] = page;

                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]);
                updateDrawerLanguageNavigation([]);

                const headerSearchInput = document.getElementById(
                    "header-search-field",
                );
                if (
                    headerSearchInput &&
                    headerSearchInput.value !== searchTerm
                ) {
                    headerSearchInput.value = searchTerm;
                }
                const drawerSearchInput = document.getElementById(
                    "drawer-search-field",
                );
                if (
                    drawerSearchInput &&
                    drawerSearchInput.value !== searchTerm
                ) {
                    drawerSearchInput.value = searchTerm;
                }

                const saneSearchTermForSql = searchTerm.replace(/'/g, "''");
                const lowerSearchTerm = searchTerm.toLowerCase();

                const localFoundItems = [];
                const allCached = getAllCachedPrayers();
                allCached.forEach((cachedPrayer) => {
                    let match = false;
                    if (
                        cachedPrayer.text &&
                        cachedPrayer.text
                            .toLowerCase()
                            .includes(lowerSearchTerm)
                    )
                        match = true;
                    if (
                        !match &&
                        cachedPrayer.name &&
                        cachedPrayer.name
                            .toLowerCase()
                            .includes(lowerSearchTerm)
                    )
                        match = true;
                    if (match) {
                        localFoundItems.push({
                            version: cachedPrayer.version,
                            name: cachedPrayer.name,
                            language: cachedPrayer.language,
                            phelps: cachedPrayer.phelps,
                            link: cachedPrayer.link,
                            opening_text: cachedPrayer.text
                                ? cachedPrayer.text.substring(
                                      0,
                                      MAX_PREVIEW_LENGTH,
                                  ) +
                                  (cachedPrayer.text.length > MAX_PREVIEW_LENGTH
                                      ? "..."
                                      : "")
                                : "No text preview.",
                            source: "cache",
                        });
                    }
                });

                const dbNameSql = `SELECT version, name, language, phelps, link FROM writings WHERE name LIKE '%${saneSearchTermForSql}%' ORDER BY name, version`;
                const dbNameItemsRaw = await executeQuery(dbNameSql);
                const dbNameItems = dbNameItemsRaw.map((item) => ({
                    ...item,
                    source: "db_name",
                }));

                let combinedResults = [];
                const processedVersions = new Set();
                localFoundItems.forEach((item) => {
                    if (!processedVersions.has(item.version)) {
                        combinedResults.push(item);
                        processedVersions.add(item.version);
                    }
                });
                dbNameItems.forEach((item) => {
                    if (!processedVersions.has(item.version)) {
                        combinedResults.push(item);
                        processedVersions.add(item.version);
                    }
                });

                const totalResults = combinedResults.length;
                const totalPages = Math.ceil(totalResults / ITEMS_PER_PAGE);
                if (page > totalPages && totalPages > 0) page = totalPages;
                else if (totalPages === 0 && page > 1) page = 1;
                currentPageBySearchTerm[searchTerm] = page;

                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                const paginatedCombinedResults = combinedResults.slice(
                    startIndex,
                    startIndex + ITEMS_PER_PAGE,
                );

                const displayItems = [];
                for (const item of paginatedCombinedResults) {
                    let displayItem = { ...item };
                    if (item.source === "db_name" && !item.opening_text) {
                        const cached = getCachedPrayerText(item.version);
                        if (cached) {
                            displayItem.name = cached.name || item.name;
                            displayItem.phelps = cached.phelps || item.phelps;
                            displayItem.language =
                                cached.language || item.language;
                            displayItem.link = cached.link || item.link;
                            displayItem.opening_text = cached.text
                                ? cached.text.substring(0, MAX_PREVIEW_LENGTH) +
                                  (cached.text.length > MAX_PREVIEW_LENGTH
                                      ? "..."
                                      : "")
                                : "No text preview.";
                        } else {
                            const textQuerySql = `SELECT text, name, phelps, language, link FROM writings WHERE version = '${item.version}' LIMIT 1`;
                            const textRows = await executeQuery(textQuerySql);
                            if (textRows.length > 0) {
                                const dbItem = textRows[0];
                                displayItem.name = dbItem.name || item.name;
                                displayItem.phelps =
                                    dbItem.phelps || item.phelps;
                                displayItem.language =
                                    dbItem.language || item.language;
                                displayItem.link = dbItem.link || item.link;
                                displayItem.opening_text = dbItem.text
                                    ? dbItem.text.substring(
                                          0,
                                          MAX_PREVIEW_LENGTH,
                                      ) +
                                      (dbItem.text.length > MAX_PREVIEW_LENGTH
                                          ? "..."
                                          : "")
                                    : "No text preview.";
                                cachePrayerText({ ...dbItem }); // Cache full fetched item
                            } else {
                                displayItem.opening_text =
                                    "Text not found for preview.";
                            }
                        }
                    }
                    displayItems.push(displayItem);
                }

                if (totalResults === 0) {
                    // ... (no change to this block)
                    const searchExplanationForNoResults = `
                        <div style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9em;">
                            <p style="margin-bottom: 5px;"><strong>Search Information:</strong></p>
                            <ul style="margin-top: 0; padding-left: 20px;">
                                <li>This search looked for "${searchTerm}" in prayer <strong>titles</strong> from the main database.</li>
                                <li>It also checked the <strong>full text</strong> of ${allCached.length} prayer(s) stored in your browser's local cache (from previously viewed or searched items).</li>
                                <li>If you can't find a prayer, try browsing the <a href="#prayers">language lists</a> to view prayers. This adds them to your local cache, which can help future searches find them by their text.</li>
                            </ul>
                        </div>`;

                    contentDiv.innerHTML = `
                        <p>No prayers found matching "${searchTerm}".</p>
                        ${searchExplanationForNoResults}
                        <p style="margin-top: 15px;">For a more comprehensive text search across the entire database (not just titles or your local cache), try <a href="https://tiddly.holywritings.net/workspace" target="_blank">tiddly.holywritings.net/workspace</a>.</p>
                        <p>Debug: <a href="${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(dbNameSql)}" target="_blank">View DB Name Query (Titles)</a></p>
                    `;
                    return;
                }

                let allPhelpsDetailsForCards = {};
                const phelpsCodesInList = [
                    ...new Set(
                        displayItems
                            .filter((p) => p.phelps)
                            .map((p) => p.phelps),
                    ),
                ];
                if (phelpsCodesInList.length > 0) {
                    const phelpsInClause = phelpsCodesInList
                        .map((p) => `'${p.replace(/'/g, "''")}'`)
                        .join(",");
                    const translationsSql = `SELECT version, language, phelps, name, link FROM writings WHERE phelps IN (${phelpsInClause})`;
                    try {
                        const translationRows =
                            await executeQuery(translationsSql);
                        translationRows.forEach((row) => {
                            if (!allPhelpsDetailsForCards[row.phelps])
                                allPhelpsDetailsForCards[row.phelps] = [];
                            allPhelpsDetailsForCards[row.phelps].push({
                                ...row,
                            });
                        });
                    } catch (e) {
                        console.error(
                            "Failed to fetch details for phelps codes in search:",
                            e,
                        );
                    }
                }

                const listCardsHtmlArray = displayItems.map((pData) =>
                    createPrayerCardHtml(pData, allPhelpsDetailsForCards),
                );
                const listHtml = `<div class="favorite-prayer-grid">${listCardsHtmlArray.join("")}</div>`;

                let paginationHtml = "";
                // ... (pagination logic unchanged)
                if (totalPages > 1) {
                    const escapedSearchTerm = searchTerm
                        .replace(/'/g, "\\'")
                        .replace(/"/g, '\\"');
                    paginationHtml = '<div class="pagination">';
                    if (page > 1)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderSearchResults('${escapedSearchTerm}', ${page - 1})">Previous</button>`;
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderSearchResults('${escapedSearchTerm}', ${page + 1})">Next</button>`;
                    paginationHtml += "</div>";
                }

                // ... (search info and tiddly suggestion unchanged)
                const searchInfoHtml = `
                    <div style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9em;">
                        <p style="margin-bottom: 5px;"><strong>How this search works:</strong></p>
                        <ul style="margin-top: 0; padding-left: 20px;">
                            <li>It searches prayer <strong>titles</strong> in the main database.</li>
                            <li>It also searches the <strong>full text</strong> of prayers you have previously viewed or found in other searches (these are stored in your browser's local cache).</li>
                            <li>To improve full-text search results for specific prayers, try viewing them first by navigating through the <a href="#prayers">language lists</a>. This adds their text to your local cache, making them searchable here.</li>
                        </ul>
                    </div>`;
                const tiddlySuggestionHtml = `<p style="margin-top: 20px; text-align: center; font-size: 0.9em;">For more comprehensive text search, or if you can't find what you're looking for, try <a href="https://tiddly.holywritings.net/workspace" target="_blank">tiddly.holywritings.net/workspace</a>.</p>`;

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Search Results</span>
                            <span id="blocktitle">For "${searchTerm}" (Page ${page})</span>
                        </h2>
                    </header>
                    ${listHtml}
                    ${paginationHtml}
                    ${searchInfoHtml}
                    ${tiddlySuggestionHtml}
                `;
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
            }

            function handleRouteChange() {
                const hash = window.location.hash;
                const [mainHashPath, queryParamsStr] = hash.split("?");

                let pageParam = 1;
                let showOnlyUnmatchedParam = false;

                if (queryParamsStr) {
                    const params = new URLSearchParams(queryParamsStr);
                    if (params.has("page")) {
                        const parsedPage = parseInt(params.get("page"), 10);
                        if (!isNaN(parsedPage) && parsedPage > 0) {
                            pageParam = parsedPage;
                        }
                    }
                    if (
                        params.has("filter") &&
                        params.get("filter") === "unmatched"
                    ) {
                        showOnlyUnmatchedParam = true;
                    }
                }

                const mainHash =
                    mainHashPath || (hash.includes("?") ? "" : hash);

                const prayerCodeLangRegex = /^#prayercode\/([^/]+)\/([^/?]+)/; // phelps/lang
                const prayerCodeLangMatch = mainHash.match(prayerCodeLangRegex);

                if (mainHash.startsWith("#search/prayers/")) {
                    const searchTerm = decodeURIComponent(
                        mainHash.substring("#search/prayers/".length),
                    );
                    if (searchTerm) {
                        const page =
                            currentPageBySearchTerm[searchTerm] || pageParam;
                        renderSearchResults(searchTerm, page);
                    } else {
                        renderLanguageList();
                    }
                } else if (prayerCodeLangMatch) {
                    const phelpsCode = decodeURIComponent(
                        prayerCodeLangMatch[1],
                    );
                    const languageCode = decodeURIComponent(
                        prayerCodeLangMatch[2],
                    );
                    // pageParam is not directly used by resolveAndRenderPrayerByPhelpsAndLang currently
                    // It resolves to one main prayer and lists others, not a paginated list itself.
                    resolveAndRenderPrayerByPhelpsAndLang(
                        phelpsCode,
                        languageCode,
                    );
                } else if (mainHash.startsWith("#prayercode/")) {
                    // General phelps code, all languages list
                    const phelpsCode = decodeURIComponent(
                        mainHash.substring("#prayercode/".length),
                    );
                    if (phelpsCode) {
                        const page =
                            currentPageByPhelpsCode[phelpsCode] || pageParam;
                        renderPrayerCodeView(phelpsCode, page);
                    } else {
                        renderLanguageList();
                    }
                } else if (mainHash.startsWith("#prayer/")) {
                    const versionId = mainHash.substring("#prayer/".length);
                    if (versionId) renderPrayer(versionId);
                    else renderLanguageList();
                } else if (mainHash.startsWith("#prayers/")) {
                    const langCode = mainHash.substring("#prayers/".length);
                    if (langCode) {
                        renderPrayersForLanguage(
                            langCode,
                            pageParam,
                            showOnlyUnmatchedParam,
                        );
                    } else {
                        renderLanguageList();
                    }
                } else if (
                    mainHash === "#prayers" ||
                    mainHash === "" ||
                    mainHash === "#"
                ) {
                    renderLanguageList();
                } else {
                    const phelpsRegex = /^#([A-Z]{2}\d{3,5}[A-Z]{0,3})$/i; // Old style direct phelps link
                    const phelpsMatch = mainHash.match(phelpsRegex);
                    if (phelpsMatch && phelpsMatch[1]) {
                        const phelpsCode = phelpsMatch[1].toUpperCase();
                        // Redirect old #PHELPS to new #prayercode/PHELPS (which lists all langs)
                        let newHash = `#prayercode/${phelpsCode}`;
                        if (pageParam > 1) newHash += `?page=${pageParam}`;
                        window.location.hash = newHash;
                    } else {
                        console.log(
                            "Unhandled hash:",
                            mainHash,
                            "defaulting to language list.",
                        );
                        renderLanguageList();
                    }
                }
            }

            function setLanguageView(langCode, page, showOnlyUnmatched) {
                let newHash = `#prayers/${langCode}?page=${page}`;
                if (showOnlyUnmatched) {
                    newHash += "&filter=unmatched";
                }
                window.location.hash = newHash;
            }
            window.setLanguageView = setLanguageView;

            window.renderPrayersForLanguage = renderPrayersForLanguage;
            window.renderSearchResults = renderSearchResults;
            window.renderPrayerCodeView = renderPrayerCodeView;

            document.addEventListener("DOMContentLoaded", () => {
                loadFavoritePrayers();

                const headerSearchInput = document.getElementById(
                    "header-search-field",
                );
                if (headerSearchInput) {
                    headerSearchInput.addEventListener(
                        "keypress",
                        function (e) {
                            if (e.key === "Enter") {
                                e.preventDefault();
                                const searchTerm =
                                    headerSearchInput.value.trim();
                                if (searchTerm) {
                                    currentPageBySearchTerm[searchTerm] = 1;
                                    window.location.hash = `#search/prayers/${encodeURIComponent(searchTerm)}`;
                                }
                            }
                        },
                    );
                }

                const drawerSearchInput = document.getElementById(
                    "drawer-search-field",
                );
                if (drawerSearchInput) {
                    drawerSearchInput.addEventListener(
                        "keypress",
                        function (e) {
                            if (e.key === "Enter") {
                                e.preventDefault();
                                const searchTerm =
                                    drawerSearchInput.value.trim();
                                if (searchTerm) {
                                    currentPageBySearchTerm[searchTerm] = 1;
                                    window.location.hash = `#search/prayers/${encodeURIComponent(searchTerm)}`;
                                    const layout =
                                        document.querySelector(".mdl-layout");
                                    if (
                                        layout &&
                                        layout.MaterialLayout &&
                                        layout.MaterialLayout.drawer_
                                    ) {
                                        layout.MaterialLayout.toggleDrawer();
                                    }
                                }
                            }
                        },
                    );
                }

                document
                    .querySelectorAll(
                        ".mdl-layout__drawer .main-drawer-nav .mdl-navigation__link",
                    )
                    .forEach((link) => {
                        link.addEventListener("click", () => {
                            const layout =
                                document.querySelector(".mdl-layout");
                            if (
                                layout &&
                                layout.MaterialLayout &&
                                layout.MaterialLayout.drawer_
                            ) {
                                layout.MaterialLayout.toggleDrawer();
                            }
                        });
                    });

                const mailMatchesButton = document.getElementById(
                    "mail-collected-matches-button",
                );
                if (mailMatchesButton) {
                    mailMatchesButton.addEventListener(
                        "click",
                        sendMatchesByEmail,
                    );
                }

                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                updatePrayerMatchingToolDisplay();
                handleRouteChange();
            });

            window.addEventListener("hashchange", handleRouteChange);
        </script>

        <script>
            if (navigator.serviceWorker.controller) {
                console.log(
                    "[PWA Builder] active service worker found, no need to register",
                );
            } else {
                navigator.serviceWorker
                    .register("pwabuilder-sw.js", {
                        scope: "./",
                    })
                    .then(function (reg) {
                        console.log(
                            "Service worker has been registered for scope:" +
                                reg.scope,
                        );
                    });
            }
        </script>
    </body>
</html>
