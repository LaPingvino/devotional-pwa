<!doctype html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Noto+Sans+Symbols+2"
        />
        <link
            rel="stylesheet"
            href="https://code.getmdl.io/1.3.0/material.blue_grey-blue.min.css"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="manifest" href="devotional.webmanifest" />
        <link rel="icon" href="/chrome/chrome-favicon-16-16.png" />
        <script
            defer
            src="https://code.getmdl.io/1.3.0/material.min.js"
        ></script>
        <title>&#x1f7d9; Holywritings.net</title>
    </head>
    <body>
        <style>
            .star {
                font-family: "Noto Sans Symbols 2";
                font-size: 1.5em;
                color: gold;
            }
            body {
                font-size: 1.3em;
                /* A soft background color for the body, MDL might override for content area */
                background-color: #f4f6f6;
            }
            /* .mdl-layout__header will now get its color from the MDL theme (blue_grey) */
            /* .mdl-layout__content will also get its background from MDL theme (typically light grey) */

            #content {
                margin: 25px 75px;
                background-color: #ffffff; /* Ensuring content area within padding is white */
                padding: 20px; /* Add some padding if margin is for spacing from edge */
                border-radius: 4px;
                box-shadow:
                    0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12);
            }
            @media screen and (max-width: 480px) {
                #content {
                    margin: 15px 15px; /* Adjusted margin for smaller screens */
                    padding: 15px;
                }
                .mdl-layout__header-row .mdl-navigation {
                    /* Ensure nav items don't overflow on small screens with search */
                    padding-left: 0;
                }
            }
            #content a {
                font-weight: bold;
                padding: 3px;
            }
            #content a + a::before {
                /* This applies to adjacent <a> tags, good for horizontal lists */
                content: " - ";
            }
            #content .prayer-list-item a + a::before {
                /* Disable for prayer list items if multiple links are inside one item */
                content: "";
            }
            .author::before {
                content: "--";
            }
            header, /* This refers to the <header> inside #content, not the main layout header */
            .scripture {
                padding-left: 1em;
            }
            .scripture {
                font-family: "Gentium", "Times New Roman", serif;
                border-left: black solid 2px;
                max-width: 800px;
            }
            .author {
                margin-top: 1em;
                margin-left: 2em;
                font-weight: bold;
            }
            h2 {
                font-size: 1.2em;
            }
            #category {
                font-size: 1.2em;
                font-weight: bold;
            }
            #blocktitle {
                color: #777777;
            }
            small {
                font-family: "Gentium", "Times New Roman", serif;
                font-size: 0.6em;
                display: block;
                margin: 5px;
                margin-top: 100px;
            }
            .prayer-list-item {
                margin-bottom: 0.5em; /* This applies to prayer lists, not the language list if it doesn't use this class */
            }
            .pagination {
                margin-top: 20px;
                text-align: center;
            }
            .pagination button {
                margin: 0 5px;
            }
            /* Style for header search field */
            .mdl-layout__header-row .mdl-textfield__input {
                color: white; /* Or contrast color depending on header */
            }
            .mdl-layout__header-row .mdl-textfield__label:after {
                background-color: white; /* Or a suitable color for the underline */
            }
        </style>

        <div class="mdl-layout mdl-js-layout">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <!-- Title -->
                    <span class="mdl-layout-title">
                        <span class="star">&#x1f7d9;</span> Holy Writings Reader
                    </span>
                    <!-- Add spacer, to align navigation to the right -->
                    <div class="mdl-layout-spacer"></div>
                    <!-- Header Search -->
                    <div
                        class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right"
                        style="margin-right: 10px"
                    >
                        <label
                            class="mdl-button mdl-js-button mdl-button--icon"
                            for="header-search-field"
                        >
                            <i class="material-icons">search</i>
                        </label>
                        <div class="mdl-textfield__expandable-holder">
                            <input
                                class="mdl-textfield__input"
                                type="text"
                                id="header-search-field"
                                placeholder="Search Prayers"
                            />
                            <label
                                class="mdl-textfield__label"
                                for="header-search-field"
                            ></label>
                        </div>
                    </div>
                    <!-- Navigation -->
                    <nav class="mdl-navigation" id="prayer-language-nav">
                        <!-- Language links for current prayer will be inserted here by JS -->
                        <a class="mdl-navigation__link" href="">Loading...</a>
                    </nav>
                </div>
            </header>
            <div class="mdl-layout__drawer">
                <span class="mdl-layout-title">Menu</span>
                <nav class="mdl-navigation">
                    <a class="mdl-navigation__link" href="#prayers">Prayers</a>
                    <a class="mdl-navigation__link" href="#songs">Songs</a>
                    <a class="mdl-navigation__link" href="#books">Books</a>
                    <a class="mdl-navigation__link" href="#programs"
                        >Programs</a
                    >
                </nav>
                <img
                    src="windows10/StoreLogo.scale-400.png"
                    style="
                        margin: 50px auto;
                        width: 100px;
                        height: 100px;
                        display: block;
                        clear: both;
                    "
                />
                <div>
                    <small
                        >Contribute on
                        <a href="https://tiddly.holywritings.net"
                            >tiddly.holywritings.net</a
                        >
                        - Put together by Joop Kiefte</small
                    >
                </div>
            </div>
            <main class="mdl-layout__content">
                <div id="content">
                    <!-- Content will be dynamically loaded here -->
                    <p>Loading content...</p>
                </div>
            </main>
        </div>

        <script>
            // DATABASE STRUCTURE ASSUMPTIONS (holywritings/bahaiwritings):
            // Table: writings
            // Columns: version, text, language, phelps, name, source, link

            const DOLTHUB_API_BASE_URL =
                "https://www.dolthub.com/api/v1alpha1/holywritings/bahaiwritings/main?q=";
            const MAX_DIRECT_LINKS_IN_HEADER = 4;
            const ITEMS_PER_PAGE = 20;

            const contentDiv = document.getElementById("content");
            const prayerLanguageNav = document.getElementById(
                "prayer-language-nav",
            );

            let currentPageByLanguage = {}; // { langCode: page }
            let currentPageBySearchTerm = {}; // { searchTerm: page }

            async function executeQuery(sql) {
                try {
                    const response = await fetch(
                        DOLTHUB_API_BASE_URL + encodeURIComponent(sql),
                    );
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    return data.rows || [];
                } catch (error) {
                    console.error("Error executing query:", error);
                    contentDiv.innerHTML = `<p>Error loading data: ${error.message}. Please try again later.</p>`;
                    return [];
                }
            }

            function getAuthorFromPhelps(phelpsCode) {
                if (
                    !phelpsCode ||
                    typeof phelpsCode !== "string" ||
                    phelpsCode.length < 2
                ) {
                    return null;
                }
                const prefix = phelpsCode.substring(0, 2).toUpperCase();
                switch (prefix) {
                    case "AB":
                        return "`Abdu'l-Bahá";
                    case "BH":
                        return "Bahá'u'lláh";
                    case "BB":
                        return "The Báb";
                    default:
                        return null;
                }
            }

            function updateHeaderNavigation(links = []) {
                prayerLanguageNav.innerHTML = "";

                if (links.length === 0) {
                    // Keep some default or empty state if needed, or ensure it's visually okay
                    const loadingLink = document.createElement("a");
                    loadingLink.className = "mdl-navigation__link";
                    loadingLink.href = ""; // No action
                    // loadingLink.textContent = ""; // Or some placeholder if absolutely necessary
                    // prayerLanguageNav.appendChild(loadingLink);
                    // Better to just leave it empty if no links are relevant
                    return;
                }

                if (links.length > MAX_DIRECT_LINKS_IN_HEADER) {
                    const buttonId = "languages-menu-button";
                    const menuButton = document.createElement("button");
                    menuButton.id = buttonId;
                    menuButton.className =
                        "mdl-button mdl-js-button mdl-button--icon";
                    const icon = document.createElement("i");
                    icon.className = "material-icons";
                    icon.textContent = "language";
                    menuButton.appendChild(icon);

                    const menuUl = document.createElement("ul");
                    menuUl.className =
                        "mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect";
                    menuUl.setAttribute("for", buttonId);

                    links.forEach((linkInfo) => {
                        const menuItemLi = document.createElement("li");
                        menuItemLi.className = "mdl-menu__item";
                        const linkA = document.createElement("a");
                        linkA.href = linkInfo.href;
                        linkA.textContent = linkInfo.text;
                        linkA.style.textDecoration = "none";
                        linkA.style.color = "inherit";
                        linkA.style.display = "block";
                        menuItemLi.appendChild(linkA);
                        menuUl.appendChild(menuItemLi);
                    });

                    prayerLanguageNav.appendChild(menuButton);
                    prayerLanguageNav.appendChild(menuUl);

                    if (typeof componentHandler !== "undefined") {
                        componentHandler.upgradeElement(menuButton);
                        componentHandler.upgradeElement(menuUl);
                    }
                } else {
                    links.forEach((linkInfo) => {
                        const link = document.createElement("a");
                        link.className = "mdl-navigation__link";
                        link.href = linkInfo.href;
                        link.textContent = linkInfo.text;
                        prayerLanguageNav.appendChild(link);
                    });
                }
            }

            async function renderPrayer(versionId) {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]);

                const sql = `SELECT version, text, language, phelps, name, source, link FROM writings WHERE version = '${versionId}' LIMIT 1`;
                const rows = await executeQuery(sql);

                if (rows.length === 0) {
                    contentDiv.innerHTML = `<p>Prayer with ID ${versionId} not found.</p>`;
                    return;
                }

                const prayer = rows[0];
                const authorName = getAuthorFromPhelps(prayer.phelps);
                let prayerTitle =
                    prayer.name ||
                    (prayer.text
                        ? prayer.text.substring(0, 50) + "..."
                        : "Prayer");

                let html = `
                    <header>
                        <h2>
                            <span id="category">Prayer</span>
                            <span id="blocktitle">${prayerTitle}</span>
                        </h2>
                    </header>
                    <div class="scripture">
                        <div class="prayer" style="white-space: pre-wrap;">${prayer.text || "No text available."}</div>
                        ${authorName ? `<div class="author">${authorName}</div>` : ""}
                        ${prayer.source ? `<div style="font-size: 0.8em; margin-left: 2em; margin-top: 0.5em; font-style: italic;">Source: ${prayer.source} ${prayer.link ? `(<a href="${prayer.link}" target="_blank">link</a>)` : ""}</div>` : ""}
                        ${prayer.phelps ? `<div style="font-size: 0.7em; margin-left: 2em; margin-top: 0.3em; color: #555;">Phelps ID: ${prayer.phelps}</div>` : ""}
                    </div>
                `;
                contentDiv.innerHTML = html;

                if (prayer.phelps) {
                    const transSql = `SELECT version, language FROM writings WHERE phelps = '${prayer.phelps}' AND phelps IS NOT NULL AND phelps != ''`;
                    const translations = await executeQuery(transSql);
                    const currentLangLink = {
                        text: prayer.language,
                        href: `#prayer/${prayer.version}`,
                    };
                    const otherLangLinks = translations.map((t) => ({
                        text: t.language,
                        href: `#prayer/${t.version}`,
                    }));
                    const uniqueLinks = new Map();
                    otherLangLinks.forEach((link) =>
                        uniqueLinks.set(link.href, link),
                    );
                    uniqueLinks.set(currentLangLink.href, currentLangLink);
                    const allLangLinksRaw = Array.from(
                        uniqueLinks.values(),
                    ).sort((a, b) => {
                        const langCompare = a.text.localeCompare(b.text);
                        return langCompare !== 0
                            ? langCompare
                            : a.href.localeCompare(b.href);
                    });
                    const processedLangLinks = [];
                    const langCounts = {};
                    allLangLinksRaw.forEach((link) => {
                        const langCode = link.text;
                        langCounts[langCode] = (langCounts[langCode] || 0) + 1;
                        let displayText = langCode.toUpperCase();
                        if (langCounts[langCode] > 1)
                            displayText += ` (${langCounts[langCode]})`;
                        processedLangLinks.push({
                            text: displayText,
                            href: link.href,
                        });
                    });
                    updateHeaderNavigation(processedLangLinks);
                } else {
                    updateHeaderNavigation([
                        {
                            text: prayer.language.toUpperCase(),
                            href: `#prayer/${prayer.version}`,
                        },
                    ]);
                }
            }

            async function renderPrayersForLanguage(langCode, page = 1) {
                currentPageByLanguage[langCode] = page;
                const offset = (page - 1) * ITEMS_PER_PAGE;
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]);
                const languageDisplayName = langCode.toUpperCase();

                const sql = `SELECT version, name, language, SUBSTRING(text, 1, 70) AS opening_text FROM writings WHERE language = '${langCode}' ORDER BY name, opening_text, version LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}`;
                const prayers = await executeQuery(sql);
                const countSql = `SELECT COUNT(*) as total FROM writings WHERE language = '${langCode}'`;
                const countResult = await executeQuery(countSql);
                const totalPrayers =
                    countResult.length > 0 ? countResult[0].total : 0;
                const totalPages = Math.ceil(totalPrayers / ITEMS_PER_PAGE);

                if (prayers.length === 0 && page === 1) {
                    contentDiv.innerHTML = `<p>No prayers found for language: ${languageDisplayName}.</p>`;
                    return;
                }
                if (prayers.length === 0 && page > 1) {
                    renderPrayersForLanguage(langCode, Math.max(1, totalPages));
                    return;
                }

                let listHtml = prayers
                    .map((p) => {
                        const displayTitle =
                            p.name ||
                            (p.opening_text
                                ? p.opening_text + "..."
                                : "Untitled Prayer");
                        return `<div class="prayer-list-item"><a href="#prayer/${p.version}">${displayTitle}</a></div>`;
                    })
                    .join("");

                let paginationHtml = "";
                if (totalPages > 1) {
                    paginationHtml = '<div class="pagination">';
                    if (page > 1)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayersForLanguage('${langCode}', ${page - 1})">Previous</button>`;
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayersForLanguage('${langCode}', ${page + 1})">Next</button>`;
                    paginationHtml += "</div>";
                }

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Language: ${languageDisplayName} (Page ${page})</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                    ${paginationHtml}
                `;
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
            }

            async function renderLanguageList() {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]);
                currentPageByLanguage = {};
                currentPageBySearchTerm = {}; // Clear search pagination state when viewing language list

                const sql = `SELECT DISTINCT language FROM writings WHERE language IS NOT NULL AND language != '' ORDER BY language`;
                const languages = await executeQuery(sql);

                if (languages.length === 0) {
                    contentDiv.innerHTML = `<p>No languages found in the database.</p>`;
                    return;
                }
                let listHtml = languages
                    .map(
                        (lang) =>
                            `<a href="#prayers/${lang.language}">${lang.language.toUpperCase()}</a>`,
                    )
                    .join("");
                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Available Languages</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                `;
            }

            async function renderSearchResults(searchTerm, page = 1) {
                currentPageBySearchTerm[searchTerm] = page;
                const offset = (page - 1) * ITEMS_PER_PAGE;

                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]); // Clear language links during search results

                // Basic sanitization for SQL LIKE (escape single quotes)
                const saneSearchTerm = searchTerm.replace(/'/g, "''");

                const sql = `SELECT version, name, language, SUBSTRING(text, 1, 100) AS opening_text FROM writings WHERE text LIKE '%${saneSearchTerm}%' ORDER BY name, opening_text, version LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}`;
                const results = await executeQuery(sql);
                const countSql = `SELECT COUNT(*) as total FROM writings WHERE text LIKE '%${saneSearchTerm}%'`;
                const countResult = await executeQuery(countSql);
                const totalResults =
                    countResult.length > 0 ? countResult[0].total : 0;
                const totalPages = Math.ceil(totalResults / ITEMS_PER_PAGE);

                const headerSearchInput = document.getElementById(
                    "header-search-field",
                );
                if (
                    headerSearchInput &&
                    headerSearchInput.value !== searchTerm
                ) {
                    headerSearchInput.value = searchTerm; // Keep search box synced if navigated via hash
                }

                if (results.length === 0 && page === 1) {
                    contentDiv.innerHTML = `<p>No prayers found matching "${searchTerm}".</p>`;
                    return;
                }
                if (results.length === 0 && page > 1) {
                    renderSearchResults(searchTerm, Math.max(1, totalPages));
                    return;
                }

                let listHtml = results
                    .map((p) => {
                        const displayTitle =
                            p.name ||
                            (p.opening_text
                                ? p.opening_text + "..."
                                : "Untitled Prayer");
                        return `<div class="prayer-list-item"><a href="#prayer/${p.version}">${displayTitle}</a> (${p.language.toUpperCase()})</div>`;
                    })
                    .join("");

                let paginationHtml = "";
                if (totalPages > 1) {
                    // Escape searchTerm for use in onclick attribute string
                    const escapedSearchTerm = searchTerm
                        .replace(/'/g, "\\'")
                        .replace(/"/g, '\\"');
                    paginationHtml = '<div class="pagination">';
                    if (page > 1)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderSearchResults('${escapedSearchTerm}', ${page - 1})">Previous</button>`;
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderSearchResults('${escapedSearchTerm}', ${page + 1})">Next</button>`;
                    paginationHtml += "</div>";
                }

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Search Results</span>
                            <span id="blocktitle">For "${searchTerm}" (Page ${page})</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                    ${paginationHtml}
                `;
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
            }

            function handleRouteChange() {
                const hash = window.location.hash;
                // Split by ?page= first to separate main route from page parameter
                const hashParts = hash.split("?page=");
                const mainHash = hashParts[0];
                let pageParam = 1; // Default page is 1
                if (hashParts.length > 1 && hashParts[1]) {
                    const parsedPage = parseInt(hashParts[1], 10);
                    if (!isNaN(parsedPage) && parsedPage > 0) {
                        pageParam = parsedPage;
                    }
                }

                if (mainHash.startsWith("#search/prayers/")) {
                    const searchTerm = decodeURIComponent(
                        mainHash.substring("#search/prayers/".length),
                    );
                    if (searchTerm) {
                        const page =
                            currentPageBySearchTerm[searchTerm] || pageParam;
                        renderSearchResults(searchTerm, page);
                    } else {
                        renderLanguageList(); // Fallback if search term is empty
                    }
                } else if (mainHash.startsWith("#prayer/")) {
                    const versionId = mainHash.substring("#prayer/".length);
                    if (versionId) renderPrayer(versionId);
                    else renderLanguageList();
                } else if (mainHash.startsWith("#prayers/")) {
                    const langCode = mainHash.substring("#prayers/".length);
                    if (langCode) {
                        const page =
                            currentPageByLanguage[langCode] || pageParam;
                        renderPrayersForLanguage(langCode, page);
                    } else {
                        renderLanguageList();
                    }
                } else if (
                    mainHash === "#prayers" ||
                    mainHash === "" ||
                    mainHash === "#"
                ) {
                    renderLanguageList();
                } else {
                    const phelpsRegex = /^#([A-Z]{2}\d{3,5}[A-Z]{0,3})$/i;
                    const phelpsMatch = mainHash.match(phelpsRegex);
                    if (phelpsMatch && phelpsMatch[1]) {
                        const phelpsCode = phelpsMatch[1].toUpperCase();
                        console.log(
                            "Phelps code detected:",
                            phelpsCode,
                            " - direct linking by Phelps not fully implemented for routing.",
                        );
                        // To implement: find versionId for phelpsCode then renderPrayer(versionId)
                        // For now, fallback:
                        renderLanguageList();
                    } else {
                        console.log(
                            "Unhandled hash:",
                            mainHash,
                            "defaulting to language list.",
                        );
                        renderLanguageList();
                    }
                }
            }

            window.renderPrayersForLanguage = renderPrayersForLanguage;
            window.renderSearchResults = renderSearchResults; // Make globally accessible for pagination

            document.addEventListener("DOMContentLoaded", () => {
                const searchInput = document.getElementById(
                    "header-search-field",
                );
                if (searchInput) {
                    searchInput.addEventListener("keypress", function (e) {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            const searchTerm = searchInput.value.trim();
                            if (searchTerm) {
                                // Reset pagination for this specific search term to page 1 for a new search action
                                currentPageBySearchTerm[searchTerm] = 1;
                                window.location.hash = `#search/prayers/${encodeURIComponent(searchTerm)}`;
                                // searchInput.blur(); // Optional: collapse search field if it's an expandable one
                                // For MDL expandable, blur often collapses it.
                                const layout =
                                    document.querySelector(".mdl-layout");
                                if (
                                    layout &&
                                    layout.MaterialLayout &&
                                    layout.classList.contains("is-focused")
                                ) {
                                    // This is tricky for MDL's own expandable behavior.
                                    // Blurring might be enough or MDL might handle it.
                                }
                            }
                        }
                    });
                }

                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                handleRouteChange();
            });

            window.addEventListener("hashchange", handleRouteChange);
        </script>

        <!-- Add ServiceWorker and manup.js -->
        <script>
            //This is the "Offline copy of pages" service worker
            if (navigator.serviceWorker.controller) {
                console.log(
                    "[PWA Builder] active service worker found, no need to register",
                );
            } else {
                navigator.serviceWorker
                    .register("pwabuilder-sw.js", {
                        scope: "./",
                    })
                    .then(function (reg) {
                        console.log(
                            "Service worker has been registered for scope:" +
                                reg.scope,
                        );
                    });
            }
        </script>
    </body>
</html>
