<!doctype html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Noto+Sans+Symbols+2"
        />
        <link
            rel="stylesheet"
            href="https://code.getmdl.io/1.3.0/material.blue_grey-blue.min.css"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="manifest" href="devotional.webmanifest" />
        <link rel="icon" href="/chrome/chrome-favicon-16-16.png" />
        <script
            defer
            src="https://code.getmdl.io/1.3.0/material.min.js"
        ></script>
        <title>&#x1f7d9; Holywritings.net</title>
    </head>
    <body>
        <style>
            .star {
                font-family: "Noto Sans Symbols 2";
                font-size: 1.5em;
                color: gold;
            }
            body {
                font-size: 1.3em;
                /* A soft background color for the body, MDL might override for content area */
                background-color: #f4f6f6;
            }
            /* .mdl-layout__header will now get its color from the MDL theme (blue_grey) */
            /* .mdl-layout__content will also get its background from MDL theme (typically light grey) */

            #content {
                margin: 25px 75px;
                background-color: #ffffff; /* Ensuring content area within padding is white */
                padding: 20px; /* Add some padding if margin is for spacing from edge */
                border-radius: 4px;
                box-shadow:
                    0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12);
            }
            @media screen and (max-width: 480px) {
                #content {
                    margin: 15px 15px; /* Adjusted margin for smaller screens */
                    padding: 15px;
                }
            }
            #content a {
                font-weight: bold;
                padding: 3px;
            }
            #content a + a::before {
                /* This applies to adjacent <a> tags, good for horizontal lists */
                content: " - ";
            }
            #content .prayer-list-item a + a::before {
                /* Disable for prayer list items if multiple links are inside one item */
                content: "";
            }
            .author::before {
                content: "--";
            }
            header, /* This refers to the <header> inside #content, not the main layout header */
            .scripture {
                padding-left: 1em;
            }
            .scripture {
                font-family: "Gentium", "Times New Roman", serif;
                border-left: black solid 2px;
                max-width: 800px;
            }
            .author {
                margin-top: 1em;
                margin-left: 2em;
                font-weight: bold;
            }
            h2 {
                font-size: 1.2em;
            }
            #category {
                font-size: 1.2em;
                font-weight: bold;
            }
            #blocktitle {
                color: #777777;
            }
            small {
                font-family: "Gentium", "Times New Roman", serif;
                font-size: 0.6em;
                display: block;
                margin: 5px;
                margin-top: 100px;
            }
            .prayer-list-item {
                margin-bottom: 0.5em; /* This applies to prayer lists, not the language list if it doesn't use this class */
            }
            .pagination {
                margin-top: 20px;
                text-align: center;
            }
            .pagination button {
                margin: 0 5px;
            }
        </style>

        <div class="mdl-layout mdl-js-layout">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <!-- Title -->
                    <span class="mdl-layout-title"
                        ><span class="star">&#x1f7d9;</span> Holy Writings
                        Reader</span
                    >
                    <!-- Add spacer, to align navigation to the right -->
                    <div class="mdl-layout-spacer"></div>
                    <!-- Navigation -->
                    <nav class="mdl-navigation" id="prayer-language-nav">
                        <!-- Language links for current prayer will be inserted here by JS -->
                        <a class="mdl-navigation__link" href="">Loading...</a>
                    </nav>
                </div>
            </header>
            <div class="mdl-layout__drawer">
                <span class="mdl-layout-title">Menu</span>
                <nav class="mdl-navigation">
                    <a class="mdl-navigation__link" href="#prayers">Prayers</a>
                    <a class="mdl-navigation__link" href="#songs">Songs</a>
                    <a class="mdl-navigation__link" href="#books">Books</a>
                    <a class="mdl-navigation__link" href="#programs"
                        >Programs</a
                    >
                </nav>
                <img
                    src="windows10/StoreLogo.scale-400.png"
                    style="
                        margin: 50px auto;
                        width: 100px;
                        height: 100px;
                        display: block;
                        clear: both;
                    "
                />
                <div>
                    <small
                        >Contribute on
                        <a href="https://tiddly.holywritings.net"
                            >tiddly.holywritings.net</a
                        >
                        - Put together by Joop Kiefte</small
                    >
                </div>
            </div>
            <main class="mdl-layout__content">
                <div id="content">
                    <!-- Content will be dynamically loaded here -->
                    <p>Loading content...</p>
                </div>
            </main>
        </div>

        <script>
            // DATABASE STRUCTURE ASSUMPTIONS (holywritings/bahaiwritings):
            // Table:             // Columns:
            //   - version (TEXT/VARCHAR, Primary Key): Unique identifier for a specific version/translation of a prayer.
            //   - text (TEXT): The full text of the prayer. Ensure this is fetched.
            //   - language (TEXT/VARCHAR): ISO 639-1 or similar language code (e.g., "en", "fr", "es").
            //   - phelps (TEXT/VARCHAR, nullable): An identifier to link different language versions of the same prayer.
            //                                        This is crucial for finding translations.
            //   - name (TEXT/VARCHAR, nullable): A short title or the first few words of the prayer, used for display in lists.
            //                                   If not available, SUBSTRING(text_content, 1, N) can be used as a fallback.
            //   - source (TEXT/VARCHAR, nullable): Reference to the original source (e.g., "Prayers and Meditations, CIX").
            //   - link (TEXT/VARCHAR, nullable): A link to the original source (e.g., a "https://bahaiprayers.net" link).

            const DOLTHUB_API_BASE_URL =
                "https://www.dolthub.com/api/v1alpha1/holywritings/bahaiwritings/main?q=";
            const MAX_DIRECT_LINKS_IN_HEADER = 4; // Max links before switching to a menu
            const ITEMS_PER_PAGE = 20; // Number of items per page for pagination

            const contentDiv = document.getElementById("content");
            const prayerLanguageNav = document.getElementById(
                "prayer-language-nav",
            );

            let currentPageByLanguage = {}; // To store current page for each language list

            async function executeQuery(sql) {
                try {
                    const response = await fetch(
                        DOLTHUB_API_BASE_URL + encodeURIComponent(sql),
                    );
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    return data.rows || [];
                } catch (error) {
                    console.error("Error executing query:", error);
                    contentDiv.innerHTML = `<p>Error loading data: ${error.message}. Please try again later.</p>`;
                    return [];
                }
            }

            function getAuthorFromPhelps(phelpsCode) {
                if (
                    !phelpsCode ||
                    typeof phelpsCode !== "string" ||
                    phelpsCode.length < 2
                ) {
                    return null;
                }
                const prefix = phelpsCode.substring(0, 2).toUpperCase();
                switch (prefix) {
                    case "AB":
                        return "`Abdu'l-Bah치";
                    case "BH":
                        return "Bah치'u'll치h";
                    case "BB":
                        return "The B치b";
                    default:
                        return null;
                }
            }

            function updateHeaderNavigation(links = []) {
                prayerLanguageNav.innerHTML = ""; // Clear existing links

                if (links.length === 0) {
                    return;
                }

                if (links.length > MAX_DIRECT_LINKS_IN_HEADER) {
                    // Show "Languages" menu button
                    const buttonId = "languages-menu-button";
                    const menuButton = document.createElement("button");
                    menuButton.id = buttonId;
                    menuButton.className =
                        "mdl-button mdl-js-button mdl-button--icon"; // Icon button

                    const icon = document.createElement("i");
                    icon.className = "material-icons";
                    icon.textContent = "language"; // Material icon for languages/translation
                    menuButton.appendChild(icon);

                    const menuUl = document.createElement("ul");
                    menuUl.className =
                        "mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect";
                    menuUl.setAttribute("for", buttonId);

                    links.forEach((linkInfo) => {
                        const menuItemLi = document.createElement("li");
                        menuItemLi.className = "mdl-menu__item";

                        const linkA = document.createElement("a");
                        linkA.href = linkInfo.href;
                        linkA.textContent = linkInfo.text; // Text is already processed (e.g., "EN (2)")
                        linkA.style.textDecoration = "none";
                        linkA.style.color = "inherit";
                        linkA.style.display = "block";

                        menuItemLi.appendChild(linkA);
                        menuUl.appendChild(menuItemLi);
                    });

                    prayerLanguageNav.appendChild(menuButton);
                    prayerLanguageNav.appendChild(menuUl);

                    if (typeof componentHandler !== "undefined") {
                        componentHandler.upgradeElement(menuButton);
                        componentHandler.upgradeElement(menuUl);
                    }
                } else {
                    // Show direct links
                    links.forEach((linkInfo) => {
                        const link = document.createElement("a");
                        link.className = "mdl-navigation__link";
                        link.href = linkInfo.href;
                        link.textContent = linkInfo.text; // Text is already processed
                        prayerLanguageNav.appendChild(link);
                    });
                }
            }

            async function renderPrayer(versionId) {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom(); // For the spinner
                }
                updateHeaderNavigation([]); // Clear previous language links

                const sql = `SELECT version, text, language, phelps, name, source, link FROM writings WHERE version = '${versionId}' LIMIT 1`;
                const rows = await executeQuery(sql);

                if (rows.length === 0) {
                    contentDiv.innerHTML = `<p>Prayer with ID ${versionId} not found.</p>`;
                    return;
                }

                const prayer = rows[0];
                const authorName = getAuthorFromPhelps(prayer.phelps);

                let prayerTitle;
                if (prayer.name) {
                    prayerTitle = prayer.name;
                } else if (prayer.text) {
                    prayerTitle = prayer.text.substring(0, 50) + "...";
                } else {
                    prayerTitle = "Prayer";
                }

                let html = `
                    <header>
                        <h2>
                            <span id="category">Prayer</span>
                            <span id="blocktitle">${prayerTitle}</span>
                        </h2>
                    </header>
                    <div class="scripture">
                        <div class="prayer" style="white-space: pre-wrap;">${prayer.text || "No text available."}</div>
                        ${authorName ? `<div class="author">${authorName}</div>` : ""}
                        ${prayer.source ? `<div style="font-size: 0.8em; margin-left: 2em; margin-top: 0.5em; font-style: italic;">Source: ${prayer.source} ${prayer.link ? `(<a href="${prayer.link}" target="_blank">link</a>)` : ""}</div>` : ""}
                        ${prayer.phelps ? `<div style="font-size: 0.7em; margin-left: 2em; margin-top: 0.3em; color: #555;">Phelps ID: ${prayer.phelps}</div>` : ""}
                    </div>
                `;
                contentDiv.innerHTML = html;

                if (prayer.phelps) {
                    const transSql = `SELECT version, language FROM writings WHERE phelps = '${prayer.phelps}' AND phelps IS NOT NULL AND phelps != ''`;
                    const translations = await executeQuery(transSql);

                    const currentLangLink = {
                        text: prayer.language, // Raw language code
                        href: `#prayer/${prayer.version}`,
                    };

                    const otherLangLinks = translations.map((t) => ({
                        text: t.language, // Raw language code
                        href: `#prayer/${t.version}`,
                    }));

                    const uniqueLinks = new Map();
                    otherLangLinks.forEach((link) =>
                        uniqueLinks.set(link.href, link),
                    );
                    uniqueLinks.set(currentLangLink.href, currentLangLink);

                    const allLangLinksRaw = Array.from(
                        uniqueLinks.values(),
                    ).sort((a, b) => {
                        const langCompare = a.text.localeCompare(b.text);
                        if (langCompare !== 0) {
                            return langCompare;
                        }
                        return a.href.localeCompare(b.href);
                    });

                    const processedLangLinks = [];
                    const langCounts = {};
                    allLangLinksRaw.forEach((link) => {
                        const langCode = link.text;
                        langCounts[langCode] = (langCounts[langCode] || 0) + 1;
                        let displayText = langCode.toUpperCase();
                        if (langCounts[langCode] > 1) {
                            displayText += ` (${langCounts[langCode]})`;
                        }
                        processedLangLinks.push({
                            text: displayText,
                            href: link.href,
                        });
                    });

                    updateHeaderNavigation(processedLangLinks);
                } else {
                    updateHeaderNavigation([
                        {
                            text: prayer.language.toUpperCase(),
                            href: `#prayer/${prayer.version}`,
                        },
                    ]);
                }
            }

            async function renderPrayersForLanguage(langCode, page = 1) {
                currentPageByLanguage[langCode] = page;
                const offset = (page - 1) * ITEMS_PER_PAGE;

                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                updateHeaderNavigation([]);

                const languageDisplayName = langCode.toUpperCase();

                // Query for current page items
                const sql = `SELECT version, name, language, SUBSTRING(text, 1, 70) AS opening_text FROM writings WHERE language = '${langCode}' ORDER BY name, opening_text, version LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}`;
                const prayers = await executeQuery(sql);

                // Query for total count for pagination (can be slow, consider alternatives if performance is an issue)
                const countSql = `SELECT COUNT(*) as total FROM writings WHERE language = '${langCode}'`;
                const countResult = await executeQuery(countSql);
                const totalPrayers =
                    countResult.length > 0 ? countResult[0].total : 0;
                const totalPages = Math.ceil(totalPrayers / ITEMS_PER_PAGE);

                if (prayers.length === 0 && page === 1) {
                    contentDiv.innerHTML = `<p>No prayers found for language: ${languageDisplayName}.</p>`;
                    return;
                }
                if (prayers.length === 0 && page > 1) {
                    // This case means user tried to go to a page that doesn't exist (e.g. after items were deleted)
                    // Go to the last valid page or first page.
                    renderPrayersForLanguage(langCode, Math.max(1, totalPages));
                    return;
                }

                let listHtml = prayers
                    .map((p) => {
                        const displayTitle =
                            p.name ||
                            (p.opening_text
                                ? p.opening_text + "..."
                                : "Untitled Prayer");
                        return `<div class="prayer-list-item"><a href="#prayer/${p.version}">${displayTitle}</a></div>`;
                    })
                    .join("");

                let paginationHtml = "";
                if (totalPages > 1) {
                    paginationHtml = '<div class="pagination">';
                    if (page > 1) {
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayersForLanguage('${langCode}', ${page - 1})">Previous</button>`;
                    }
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages) {
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayersForLanguage('${langCode}', ${page + 1})">Next</button>`;
                    }
                    paginationHtml += "</div>";
                }

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Language: ${languageDisplayName} (Page ${page})</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                    ${paginationHtml}
                `;
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom(); // For MDL buttons in pagination
                }
            }

            async function renderLanguageList() {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                updateHeaderNavigation([]);
                currentPageByLanguage = {}; // Reset page states when going to language list

                const sql = `SELECT DISTINCT language FROM writings WHERE language IS NOT NULL AND language != '' ORDER BY language`;
                const languages = await executeQuery(sql);

                if (languages.length === 0) {
                    contentDiv.innerHTML = `<p>No languages found in the database.</p>`;
                    return;
                }

                let listHtml = languages
                    .map(
                        (lang) =>
                            `<a href="#prayers/${lang.language}">${lang.language.toUpperCase()}</a>`,
                    )
                    .join("");

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Available Languages</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                `;
            }

            function handleRouteChange() {
                const hash = window.location.hash;
                const hashParts = hash.split("?page=");
                const mainHash = hashParts[0];
                const pageParam = hashParts[1] ? parseInt(hashParts[1], 10) : 1;

                if (mainHash.startsWith("#prayer/")) {
                    const versionId = mainHash.substring("#prayer/".length);
                    if (versionId) {
                        renderPrayer(versionId);
                    } else {
                        renderLanguageList();
                    }
                } else if (mainHash.startsWith("#prayers/")) {
                    const langCode = mainHash.substring("#prayers/".length);
                    if (langCode) {
                        // Use stored page for this language if available, else default to page from URL or 1
                        const page =
                            currentPageByLanguage[langCode] || pageParam || 1;
                        renderPrayersForLanguage(langCode, page);
                    } else {
                        renderLanguageList();
                    }
                } else if (
                    mainHash === "#prayers" ||
                    mainHash === "" ||
                    mainHash === "#"
                ) {
                    renderLanguageList();
                } else {
                    // Check for Phelps code hash (e.g. #BH001)
                    const phelpsRegex = /^#([A-Z]{2}\d{3,5}[A-Z]{0,3})$/i;
                    const phelpsMatch = mainHash.match(phelpsRegex);
                    if (phelpsMatch && phelpsMatch[1]) {
                        const phelpsCode = phelpsMatch[1].toUpperCase();
                        // Attempt to find a prayer with this Phelps code (e.g., the English version or first found)
                        // This might require an adjusted query or strategy, for now, we'll just log it
                        // and potentially default to a prayer view if we can find one.
                        // For now, we assume versionId is used for direct prayer linking.
                        // To make this work, we'd need to query for `WHERE phelps = '${phelpsCode}' LIMIT 1`
                        // and then call renderPrayer with the found `version`.
                        console.log(
                            "Phelps code detected:",
                            phelpsCode,
                            " - feature to directly link by Phelps not fully implemented for routing yet.",
                        );
                        // As a fallback or if direct Phelps routing isn't implemented, go to language list
                        renderLanguageList();
                    } else {
                        console.log(
                            "Unhandled hash:",
                            mainHash,
                            "defaulting to language list.",
                        );
                        renderLanguageList();
                    }
                }
            }

            // Make renderPrayersForLanguage globally accessible for pagination buttons
            window.renderPrayersForLanguage = renderPrayersForLanguage;

            window.addEventListener("hashchange", handleRouteChange);
            document.addEventListener("DOMContentLoaded", () => {
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                handleRouteChange();
            });
        </script>

        <!-- Add ServiceWorker and manup.js -->
        <script>
            //This is the "Offline copy of pages" service worker
            if (navigator.serviceWorker.controller) {
                console.log(
                    "[PWA Builder] active service worker found, no need to register",
                );
            } else {
                navigator.serviceWorker
                    .register("pwabuilder-sw.js", {
                        scope: "./",
                    })
                    .then(function (reg) {
                        console.log(
                            "Service worker has been registered for scope:" +
                                reg.scope,
                        );
                    });
            }
        </script>
    </body>
</html>
