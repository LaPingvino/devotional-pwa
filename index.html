<!doctype html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Noto+Sans+Symbols+2"
        />
        <link
            rel="stylesheet"
            href="https://code.getmdl.io/1.3.0/material.blue_grey-blue.min.css"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="manifest" href="devotional.webmanifest" />
        <link rel="icon" href="/chrome/chrome-favicon-16-16.png" />
        <script
            defer
            src="https://code.getmdl.io/1.3.0/material.min.js"
        ></script>
        <title>&#x1f7d9; Holywritings.net</title>
    </head>
    <body>
        <style>
            .star {
                font-family: "Noto Sans Symbols 2";
                font-size: 1.5em;
                color: gold;
            }
            body {
                font-size: 1.3em;
                /* A soft background color for the body, MDL might override for content area */
                background-color: #f4f6f6;
            }
            /* .mdl-layout__header will now get its color from the MDL theme (blue_grey) */
            /* .mdl-layout__content will also get its background from MDL theme (typically light grey) */

            #content {
                margin: 25px 75px;
                background-color: #ffffff; /* Ensuring content area within padding is white */
                padding: 20px; /* Add some padding if margin is for spacing from edge */
                border-radius: 4px;
                box-shadow:
                    0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12);
            }
            @media screen and (max-width: 480px) {
                #content {
                    margin: 15px 15px; /* Adjusted margin for smaller screens */
                    padding: 15px;
                }
            }
            #content a {
                font-weight: bold;
                padding: 3px;
            }
            #content a + a::before {
                /* This applies to adjacent <a> tags, good for horizontal lists */
                content: " - ";
            }
            #content .prayer-list-item a + a::before {
                /* Disable for prayer list items if multiple links are inside one item */
                content: "";
            }
            .author::before {
                content: "--";
            }
            header, /* This refers to the <header> inside #content, not the main layout header */
            .scripture {
                padding-left: 1em;
            }
            .scripture {
                font-family: "Gentium", "Times New Roman", serif;
                border-left: black solid 2px;
                max-width: 800px;
            }
            .author {
                margin-top: 1em;
                margin-left: 2em;
                font-weight: bold;
            }
            h2 {
                font-size: 1.2em;
            }
            #category {
                font-size: 1.2em;
                font-weight: bold;
            }
            #blocktitle {
                color: #777777;
            }
            small {
                font-family: "Gentium", "Times New Roman", serif;
                font-size: 0.6em;
                display: block;
                margin: 5px;
                margin-top: 100px;
            }
            .prayer-list-item {
                margin-bottom: 0.5em; /* This applies to prayer lists, not the language list if it doesn't use this class */
            }
        </style>

        <div class="mdl-layout mdl-js-layout">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <!-- Title -->
                    <span class="mdl-layout-title"
                        ><span class="star">&#x1f7d9;</span> Holy Writings
                        Reader</span
                    >
                    <!-- Add spacer, to align navigation to the right -->
                    <div class="mdl-layout-spacer"></div>
                    <!-- Navigation -->
                    <nav class="mdl-navigation" id="prayer-language-nav">
                        <!-- Language links for current prayer will be inserted here by JS -->
                        <a class="mdl-navigation__link" href="">Loading...</a>
                    </nav>
                </div>
            </header>
            <div class="mdl-layout__drawer">
                <span class="mdl-layout-title">Menu</span>
                <nav class="mdl-navigation">
                    <a class="mdl-navigation__link" href="#prayers">Prayers</a>
                    <a class="mdl-navigation__link" href="#songs">Songs</a>
                    <a class="mdl-navigation__link" href="#books">Books</a>
                    <a class="mdl-navigation__link" href="#programs"
                        >Programs</a
                    >
                </nav>
                <img
                    src="windows10/StoreLogo.scale-400.png"
                    style="
                        margin: 50px auto;
                        width: 100px;
                        height: 100px;
                        display: block;
                        clear: both;
                    "
                />
                <div>
                    <small
                        >Contribute on
                        <a href="https://tiddly.holywritings.net"
                            >tiddly.holywritings.net</a
                        >
                        - Put together by Joop Kiefte</small
                    >
                </div>
            </div>
            <main class="mdl-layout__content">
                <div id="content">
                    <!-- Content will be dynamically loaded here -->
                    <p>Loading content...</p>
                </div>
            </main>
        </div>

        <script>
            // DATABASE STRUCTURE ASSUMPTIONS (holywritings/bahaiwritings):
            // Table:             // Columns:
            //   - version (TEXT/VARCHAR, Primary Key): Unique identifier for a specific version/translation of a prayer.
            //   - text (TEXT): The full text of the prayer. Ensure this is fetched.
            //   - language (TEXT/VARCHAR): ISO 639-1 or similar language code (e.g., "en", "fr", "es").
            //   - phelps (TEXT/VARCHAR, nullable): An identifier to link different language versions of the same prayer.
            //                                        This is crucial for finding translations.
            //   - name (TEXT/VARCHAR, nullable): A short title or the first few words of the prayer, used for display in lists.
            //                                   If not available, SUBSTRING(text_content, 1, N) can be used as a fallback.
            //   - source (TEXT/VARCHAR, nullable): Reference to the original source (e.g., "Prayers and Meditations, CIX").
            //   - link (TEXT/VARCHAR, nullable): A link to the original source (e.g., a "https://bahaiprayers.net" link).

            const DOLTHUB_API_BASE_URL =
                "https://www.dolthub.com/api/v1alpha1/holywritings/bahaiwritings/main?q=";

            const contentDiv = document.getElementById("content");
            const prayerLanguageNav = document.getElementById(
                "prayer-language-nav",
            );

            async function executeQuery(sql) {
                try {
                    const response = await fetch(
                        DOLTHUB_API_BASE_URL + encodeURIComponent(sql),
                    );
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    return data.rows || [];
                } catch (error) {
                    console.error("Error executing query:", error); // Corrected console.err or to console.error
                    contentDiv.innerHTML = `<p>Error loading data: ${error.message}. Please try again later.</p>`;
                    return [];
                }
            }

            function updateHeaderNavigation(links = []) {
                prayerLanguageNav.innerHTML = ""; // Clear existing links
                if (links.length === 0) {
                    // Optional: add a default message or leave empty
                    // const defaultLink = document.createElement('a');
                    // defaultLink.className = 'mdl-navigation__link';
                    // defaultLink.textContent = 'Holy Writings';
                    // prayerLanguageNav.appendChild(defaultLink);
                    return;
                }
                links.forEach((linkInfo) => {
                    const link = document.createElement("a");
                    link.className = "mdl-navigation__link";
                    link.href = linkInfo.href;
                    link.textContent = linkInfo.text.toUpperCase();
                    prayerLanguageNav.appendChild(link);
                });
            }

            async function renderPrayer(versionId) {
                // Parameter name kept for consistency with hash, but refers to 'version'
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                updateHeaderNavigation([]);

                // Use 'writings' table and its columns
                const sql = `SELECT version, text, language, phelps, name, source, link FROM writings WHERE version = '${versionId}' LIMIT 1`;
                const rows = await executeQuery(sql);

                if (rows.length === 0) {
                    contentDiv.innerHTML = `<p>Prayer with ID ${versionId} not found.</p>`;
                    return;
                }

                const prayer = rows[0];

                let prayerTitle;
                if (prayer.name) {
                    prayerTitle = prayer.name;
                } else if (prayer.text) {
                    prayerTitle = prayer.text.substring(0, 50) + "...";
                } else {
                    prayerTitle = "Prayer"; // Fallback
                }

                let html = `
                    <header>
                        <h2>
                            <span id="category">Prayer</span>
                            <span id="blocktitle">${prayerTitle}</span>
                        </h2>
                    </header>
                    <div class="scripture">
                        <div class="prayer" style="white-space: pre-wrap;">${prayer.text || "No text available."}</div>
                        ${prayer.source ? `<div style="font-size: 0.8em; margin-left: 2em; margin-top: 0.5em; font-style: italic;">Source: ${prayer.source} ${prayer.link ? `(<a href="${prayer.link}" target="_blank">link</a>)` : ""}</div>` : ""}
                        ${prayer.phelps ? `<div style="font-size: 0.7em; margin-left: 2em; margin-top: 0.3em; color: #555;">Phelps ID: ${prayer.phelps}</div>` : ""}
                    </div>
                `;
                contentDiv.innerHTML = html;

                if (prayer.phelps) {
                    const transSql = `SELECT version, language FROM writings WHERE phelps = '${prayer.phelps}' AND phelps IS NOT NULL AND phelps != ''`;
                    const translations = await executeQuery(transSql);
                    const langLinks = translations
                        .filter((t) => t.version !== prayer.version) // Exclude current prayer
                        .map((t) => ({
                            text: t.language,
                            href: `#prayer/${t.version}`,
                        }));

                    // Add link to current language version as well for context
                    const currentLangLink = {
                        text: prayer.language,
                        href: `#prayer/${prayer.version}`,
                    };
                    const allLangLinks = [currentLangLink, ...langLinks].sort(
                        (a, b) => a.text.localeCompare(b.text),
                    );

                    updateHeaderNavigation(allLangLinks);
                } else {
                    updateHeaderNavigation([
                        {
                            text: prayer.language,
                            href: `#prayer/${prayer.version}`,
                        },
                    ]);
                }
            }

            async function renderPrayersForLanguage(langCode) {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                updateHeaderNavigation([]);

                const languageDisplayName = langCode.toUpperCase();

                // Use 'writings' table and its columns. SUBSTRING uses 'text'. 'author' is removed.
                const sql = `SELECT version, name, language, SUBSTRING(text, 1, 70) AS opening_text FROM writings WHERE language = '${langCode}' ORDER BY name, opening_text, version`;
                const prayers = await executeQuery(sql);

                // executeQuery will set contentDiv.innerHTML to an error message and return [] if the query fails.
                // If prayers is empty, we need to determine if it's because of a query failure (where an error
                // message is already shown by executeQuery) or simply no data was found (in which case we
                // show the "No prayers found" message).
                if (prayers.length === 0) {
                    // Check if contentDiv's first child is still the spinner.
                    // If executeQuery encountered an error, it would have replaced the spinner
                    // with an error message (typically a <p> element).
                    const firstChildInContent = contentDiv.firstChild;
                    const isSpinnerStillPresent =
                        firstChildInContent &&
                        firstChildInContent.nodeName === "DIV" && // Spinner is a div
                        firstChildInContent.classList &&
                        firstChildInContent.classList.contains("mdl-spinner");

                    if (isSpinnerStillPresent) {
                        // The spinner is still there, meaning executeQuery was successful but found no prayers.
                        contentDiv.innerHTML = `<p>No prayers found for language: ${languageDisplayName}.</p>`;
                    }
                    // If the spinner is NOT present, it implies executeQuery already set an error message
                    // in contentDiv. In this case, we don't overwrite it, allowing the more specific
                    // error from executeQuery to be displayed.
                    return; // Return whether it was "no data" or an error already handled by executeQuery.
                }

                let listHtml = prayers
                    .map((p) => {
                        // Use p.name instead of p.title. Remove p.author.
                        const displayTitle =
                            p.name ||
                            (p.opening_text
                                ? p.opening_text + "..."
                                : "Untitled Prayer");
                        return `<div class="prayer-list-item"><a href="#prayer/${p.version}">${displayTitle}</a></div>`;
                    })
                    .join("");

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Language: ${languageDisplayName}</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                `;
            }

            async function renderLanguageList() {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                updateHeaderNavigation([]);

                // Use 'writings' table and 'language' column
                const sql = `SELECT DISTINCT language FROM writings WHERE language IS NOT NULL AND language != '' ORDER BY language`;
                const languages = await executeQuery(sql);

                if (languages.length === 0) {
                    contentDiv.innerHTML = `<p>No languages found in the database.</p>`;
                    return;
                }

                // Changed to generate <a> tags directly for a side-by-side list
                // The CSS rule #content a + a::before will add separators
                let listHtml = languages
                    .map(
                        (lang) =>
                            // Use lang.language instead of lang.language_code
                            // Removed the <div class="prayer-list-item"> wrapper
                            `<a href="#prayers/${lang.language}">${lang.language.toUpperCase()}</a>`,
                    )
                    .join(""); // Joins <a> tags like <a>EN</a><a>FR</a>...

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Available Languages</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                `;
            }

            function handleRouteChange() {
                const hash = window.location.hash;

                if (hash.startsWith("#prayer/")) {
                    const versionId = hash.substring("#prayer/".length); // This ID refers to 'version' column
                    if (versionId) {
                        renderPrayer(versionId);
                    } else {
                        renderLanguageList(); // Fallback if ID is missing
                    }
                } else if (hash.startsWith("#prayers/")) {
                    const langCode = hash.substring("#prayers/".length);
                    if (langCode) {
                        renderPrayersForLanguage(langCode);
                    } else {
                        renderLanguageList(); // Fallback if lang code is missing
                    }
                } else if (hash === "#prayers" || hash === "" || hash === "#") {
                    renderLanguageList();
                } else {
                    // Fallback for other unrecognised hashes or initial load without specific prayer hash
                    // For example, #songs, #books, #programs will currently fall here.
                    // You might want to add specific handlers for these or a generic "not found" page.
                    console.log(
                        "Unhandled hash:",
                        hash,
                        "defaulting to language list for now.", // Or render a specific "not implemented" message
                    );
                    // For now, rendering language list or a more generic message for unhandled routes:
                    // contentDiv.innerHTML = `<p>Section ${hash} is not yet implemented.</p><p><a href="#prayers">Go to Prayers</a></p>`;
                    renderLanguageList(); // Defaulting to language list for any other hash.
                }
            }

            window.addEventListener("hashchange", handleRouteChange);
            document.addEventListener("DOMContentLoaded", () => {
                // Ensure MDL components are upgraded after initial dynamic content might be added
                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                handleRouteChange(); // Initial route handling
            });
        </script>

        <!-- Add ServiceWorker and manup.js -->
        <script>
            //This is the "Offline copy of pages" service worker

            //Add this below content to your HTML page, or add the js file to your page at the very top to register service worker
            if (navigator.serviceWorker.controller) {
                console.log(
                    "[PWA Builder] active service worker found, no need to register",
                );
            } else {
                //Register the ServiceWorker
                navigator.serviceWorker
                    .register("pwabuilder-sw.js", {
                        scope: "./",
                    })
                    .then(function (reg) {
                        console.log(
                            "Service worker has been registered for scope:" +
                                reg.scope,
                        );
                    });
            }
        </script>
    </body>
</html>
