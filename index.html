<!doctype html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/icon?family=Noto+Sans+Symbols+2"
        />
        <link
            rel="stylesheet"
            href="https://code.getmdl.io/1.3.0/material.blue_grey-blue.min.css"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="manifest" href="devotional.webmanifest" />
        <link rel="icon" href="/chrome/chrome-favicon-16-16.png" />
        <script
            defer
            src="https://code.getmdl.io/1.3.0/material.min.js"
        ></script>
        <title>&#x1f7d9; Holywritings.net</title>
    </head>
    <body>
        <style>
            .star {
                font-family: "Noto Sans Symbols 2";
                font-size: 1.5em;
                color: gold;
            }
            body {
                font-size: 1.3em;
                /* A soft background color for the body, MDL might override for content area */
                background-color: #f4f6f6;
            }
            /* .mdl-layout__header will now get its color from the MDL theme (blue_grey) */
            /* .mdl-layout__content will also get its background from MDL theme (typically light grey) */

            #content {
                margin: 25px 75px;
                background-color: #ffffff; /* Ensuring content area within padding is white */
                padding: 20px; /* Add some padding if margin is for spacing from edge */
                border-radius: 4px;
                box-shadow:
                    0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12);
            }
            @media screen and (max-width: 480px) {
                #content {
                    margin: 15px 15px; /* Adjusted margin for smaller screens */
                    padding: 15px;
                }
                .mdl-layout__header-row .mdl-navigation {
                    /* Ensure nav items don't overflow on small screens with search */
                    padding-left: 0;
                }
            }
            #content a {
                font-weight: bold;
                padding: 3px;
            }
            /* This rule for ' - ' separator between links will no longer apply to the language list,
               as it will use buttons. It remains for other links in #content. */
            #content a + a::before {
                content: " - ";
            }
            #content .prayer-list-item a + a::before {
                /* Disable for prayer list items if multiple links are inside one item */
                content: "";
            }
            /* Specific style for prayer code list items, to avoid double separators */
            #content .prayer-code-list-item a + a::before {
                content: "";
            }

            .author::before {
                content: "--";
            }
            header, /* This refers to the <header> inside #content, not the main layout header */
            .scripture {
                padding-left: 1em;
            }
            .scripture {
                font-family: "Gentium", "Times New Roman", serif;
                border-left: black solid 2px;
                max-width: 800px;
            }
            .author {
                margin-top: 1em;
                margin-left: 2em;
                font-weight: bold;
            }
            h2 {
                font-size: 1.2em;
            }
            #category {
                font-size: 1.2em;
                font-weight: bold;
            }
            #blocktitle {
                color: #777777;
            }
            small {
                font-family: "Gentium", "Times New Roman", serif;
                font-size: 0.6em;
                display: block;
                margin: 5px;
                margin-top: 100px;
            }
            .prayer-list-item {
                margin-bottom: 0.5em;
            }
            .pagination {
                margin-top: 20px;
                text-align: center;
            }
            .pagination button {
                margin: 0 5px;
            }
            /* Style for header search field */
            .mdl-layout__header-row .mdl-textfield__input {
                color: white; /* Or contrast color depending on header */
            }
            .mdl-layout__header-row .mdl-textfield__label:after {
                background-color: white; /* Or a suitable color for the underline */
            }

            /* Styles for the new language buttons container */
            .language-buttons-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center; /* Center buttons if they don't fill the row */
                padding: 10px 0; /* Add some vertical padding */
            }
            .language-buttons-container .mdl-button {
                margin: 5px; /* Spacing around each button */
                text-transform: uppercase; /* Ensure language codes are uppercase */
            }
        </style>

        <div class="mdl-layout mdl-js-layout">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <!-- Title -->
                    <span class="mdl-layout-title">
                        <span class="star">&#x1f7d9;</span> Holy Writings Reader
                    </span>
                    <!-- Add spacer, to align navigation to the right -->
                    <div class="mdl-layout-spacer"></div>
                    <!-- Header Search -->
                    <div
                        class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right"
                        style="margin-right: 10px"
                    >
                        <label
                            class="mdl-button mdl-js-button mdl-button--icon"
                            for="header-search-field"
                        >
                            <i class="material-icons">search</i>
                        </label>
                        <div class="mdl-textfield__expandable-holder">
                            <input
                                class="mdl-textfield__input"
                                type="text"
                                id="header-search-field"
                                placeholder="Search Prayers"
                            />
                            <label
                                class="mdl-textfield__label"
                                for="header-search-field"
                            ></label>
                        </div>
                    </div>
                    <!-- Navigation -->
                    <nav class="mdl-navigation" id="prayer-language-nav">
                        <!-- Language links for current prayer will be inserted here by JS -->
                        <a class="mdl-navigation__link" href="">Loading...</a>
                    </nav>
                </div>
            </header>
            <div class="mdl-layout__drawer">
                <span class="mdl-layout-title">Menu</span>
                <nav class="mdl-navigation">
                    <a class="mdl-navigation__link" href="#prayers">Prayers</a>
                    <a class="mdl-navigation__link" href="#songs">Songs</a>
                    <a class="mdl-navigation__link" href="#books">Books</a>
                    <a class="mdl-navigation__link" href="#programs"
                        >Programs</a
                    >
                </nav>
                <img
                    src="windows10/StoreLogo.scale-400.png"
                    style="
                        margin: 50px auto;
                        width: 100px;
                        height: 100px;
                        display: block;
                        clear: both;
                    "
                />
                <div>
                    <small
                        >Contribute on
                        <a href="https://tiddly.holywritings.net"
                            >tiddly.holywritings.net</a
                        >
                        - Put together by Joop Kiefte</small
                    >
                </div>
            </div>
            <main class="mdl-layout__content">
                <div id="content">
                    <!-- Content will be dynamically loaded here -->
                    <p>Loading content...</p>
                </div>
                <div
                    style="
                        margin: 25px 75px;
                        padding: 20px;
                        background-color: #e8f5e9;
                        border-radius: 4px;
                        box-shadow:
                            0 2px 2px 0 rgba(0, 0, 0, 0.14),
                            0 3px 1px -2px rgba(0, 0, 0, 0.2),
                            0 1px 5px 0 rgba(0, 0, 0, 0.12);
                    "
                >
                    <h3>How to Contribute</h3>
                    <p>
                        You can help improve this collection of holy writings by
                        contributing in the following ways:
                    </p>
                    <ul>
                        <li>
                            <strong>Find other language versions:</strong> If
                            you find a prayer in a different language that
                            matches one on this site, please send the Phelps
                            code (if available) or the link of the page from
                            this site, along with the link of the matching
                            prayer, to
                            <a href="mailto:ikojba@gmail.com"
                                >ikojba@gmail.com</a
                            >.
                        </li>
                        <li>
                            <strong>Contribute directly on DoltHub:</strong> You
                            can contribute directly to the database on
                            <a
                                href="https://www.dolthub.com/repositories/holywritings/bahaiwritings"
                                target="_blank"
                                >dolthub.com</a
                            >.
                        </li>
                        <li>
                            <strong>Match prayers on TiddlyWiki:</strong> Visit
                            <a
                                href="https://tiddly.holywritings.net/workspace"
                                target="_blank"
                                >tiddly.holywritings.net/workspace</a
                            >
                            to match prayers. Save your results and email the
                            saved page to
                            <a href="mailto:ikojba@gmail.com"
                                >ikojba@gmail.com</a
                            >.
                        </li>
                        <li>
                            <strong>Assign missing Phelps codes</strong> Some
                            prayers don't have a Phelps code assigned to them
                            yet in any language. To correct this, you need to
                            match the prayer with its entry in
                            <a
                                href="https://afnanlibrary.org/a-partial-inventory/"
                            >
                                A Partial Inventory </a
                            >. If the prayer is part of a bigger work, you also
                            need to add a three letter suffix, usually a
                            mnemonic to its contents.
                        </li>
                    </ul>
                    <p>Your contributions are greatly appreciated!</p>
                </div>
            </main>
        </div>

        <script>
            // DATABASE STRUCTURE ASSUMPTIONS (holywritings/bahaiwritings):
            // Table: writings
            // Columns: version, text, language, phelps, name, source, link

            const DOLTHUB_API_BASE_URL =
                "https://www.dolthub.com/api/v1alpha1/holywritings/bahaiwritings/main?q=";
            const DOLTHUB_REPO_QUERY_URL_BASE =
                "https://www.dolthub.com/repositories/holywritings/bahaiwritings/query/main?q=";
            const MAX_DIRECT_LINKS_IN_HEADER = 4;
            const ITEMS_PER_PAGE = 20;
            const LOCALSTORAGE_PRAYER_CACHE_PREFIX = "hw_prayer_cache_";

            const contentDiv = document.getElementById("content");
            const prayerLanguageNav = document.getElementById(
                "prayer-language-nav",
            );

            let currentPageByLanguage = {}; // { langCode: page }
            let currentPageBySearchTerm = {}; // { searchTerm: page }
            let currentPageByPhelpsCode = {}; // { phelpsCode: page }

            // --- LocalStorage Cache Functions ---
            function cachePrayerText(prayerData) {
                if (
                    !prayerData ||
                    !prayerData.version ||
                    typeof prayerData.text === "undefined"
                ) {
                    //text can be null
                    console.warn(
                        "Attempted to cache invalid prayer data",
                        prayerData,
                    );
                    return;
                }
                try {
                    const key = `${LOCALSTORAGE_PRAYER_CACHE_PREFIX}${prayerData.version}`;
                    const dataToStore = {
                        version: prayerData.version,
                        text: prayerData.text,
                        name: prayerData.name || null,
                        language: prayerData.language || null,
                        timestamp: Date.now(),
                    };
                    localStorage.setItem(key, JSON.stringify(dataToStore));
                } catch (e) {
                    console.error(
                        "Error caching prayer text to localStorage:",
                        e,
                    );
                    // Potentially handle quota exceeded error, though not required by prompt
                }
            }

            function getCachedPrayerText(versionId) {
                try {
                    const key = `${LOCALSTORAGE_PRAYER_CACHE_PREFIX}${versionId}`;
                    const storedData = localStorage.getItem(key);
                    if (storedData) {
                        return JSON.parse(storedData);
                    }
                } catch (e) {
                    console.error(
                        "Error retrieving cached prayer text from localStorage:",
                        e,
                    );
                }
                return null;
            }

            function getAllCachedPrayers() {
                const cachedPrayers = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (
                        key &&
                        key.startsWith(LOCALSTORAGE_PRAYER_CACHE_PREFIX)
                    ) {
                        try {
                            const item = JSON.parse(localStorage.getItem(key));
                            // Ensure item has at least version and text (text can be null if prayer genuinely has no text)
                            if (
                                item &&
                                item.version &&
                                typeof item.text !== "undefined"
                            ) {
                                cachedPrayers.push(item);
                            }
                        } catch (e) {
                            console.warn(
                                "Error parsing a cached prayer from localStorage:",
                                key,
                                e,
                            );
                        }
                    }
                }
                return cachedPrayers;
            }
            // --- End LocalStorage Cache Functions ---

            async function executeQuery(sql) {
                try {
                    const response = await fetch(
                        DOLTHUB_API_BASE_URL + encodeURIComponent(sql),
                    );
                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }
                    const data = await response.json();
                    return data.rows || [];
                } catch (error) {
                    console.error("Error executing query:", error);
                    contentDiv.innerHTML = `<p>Error loading data: ${error.message}. Please try again later.</p>`;
                    return [];
                }
            }

            function getAuthorFromPhelps(phelpsCode) {
                if (
                    !phelpsCode ||
                    typeof phelpsCode !== "string" ||
                    phelpsCode.length < 2
                ) {
                    return null;
                }
                const prefix = phelpsCode.substring(0, 2).toUpperCase();
                switch (prefix) {
                    case "AB":
                        return "`Abdu'l-Bahá";
                    case "BH":
                        return "Bahá'u'lláh";
                    case "BB":
                        return "The Báb";
                    default:
                        return null;
                }
            }

            function updateHeaderNavigation(links = []) {
                prayerLanguageNav.innerHTML = "";

                if (links.length === 0) {
                    return;
                }

                if (links.length > MAX_DIRECT_LINKS_IN_HEADER) {
                    const buttonId = "languages-menu-button";
                    const menuButton = document.createElement("button");
                    menuButton.id = buttonId;
                    menuButton.className =
                        "mdl-button mdl-js-button mdl-button--icon";
                    const icon = document.createElement("i");
                    icon.className = "material-icons";
                    icon.textContent = "language";
                    menuButton.appendChild(icon);

                    const menuUl = document.createElement("ul");
                    menuUl.className =
                        "mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect";
                    menuUl.setAttribute("for", buttonId);

                    links.forEach((linkInfo) => {
                        const menuItemLi = document.createElement("li");
                        menuItemLi.className = "mdl-menu__item";
                        const linkA = document.createElement("a");
                        linkA.href = linkInfo.href;
                        linkA.textContent = linkInfo.text;
                        linkA.style.textDecoration = "none";
                        linkA.style.color = "inherit";
                        linkA.style.display = "block";
                        menuItemLi.appendChild(linkA);
                        menuUl.appendChild(menuItemLi);
                    });

                    prayerLanguageNav.appendChild(menuButton);
                    prayerLanguageNav.appendChild(menuUl);

                    if (typeof componentHandler !== "undefined") {
                        componentHandler.upgradeElement(menuButton);
                        componentHandler.upgradeElement(menuUl);
                    }
                } else {
                    links.forEach((linkInfo) => {
                        const link = document.createElement("a");
                        link.className = "mdl-navigation__link";
                        link.href = linkInfo.href;
                        link.textContent = linkInfo.text;
                        prayerLanguageNav.appendChild(link);
                    });
                }
            }

            async function renderPrayer(versionId) {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]);

                const sql = `SELECT version, text, language, phelps, name, source, link FROM writings WHERE version = '${versionId}' LIMIT 1`;
                const rows = await executeQuery(sql);

                if (rows.length === 0) {
                    const debugQueryUrl = `${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(sql)}`;
                    contentDiv.innerHTML = `
                        <p>Prayer with ID ${versionId} not found.</p>
                        <p>Query used:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${sql}</pre>
                        <p><a href="${debugQueryUrl}" target="_blank">Debug this query on DoltHub</a></p>
                    `;
                    return;
                }

                const prayer = rows[0];

                // Cache the fetched prayer text
                cachePrayerText({
                    version: prayer.version,
                    text: prayer.text,
                    name: prayer.name,
                    language: prayer.language,
                });

                const authorName = getAuthorFromPhelps(prayer.phelps);
                let prayerTitle =
                    prayer.name ||
                    (prayer.text
                        ? prayer.text.substring(0, 50) + "..."
                        : "Prayer");

                const phelpsLinkHtml = prayer.phelps
                    ? `<a href="#prayercode/${prayer.phelps}">${prayer.phelps}</a>`
                    : "";

                let html = `
                    <header>
                        <h2>
                            <span id="category">Prayer</span>
                            <span id="blocktitle">${prayerTitle}</span>
                        </h2>
                    </header>
                    <div class="scripture">
                        <div class="prayer" style="white-space: pre-wrap;">${prayer.text || "No text available."}</div>
                        ${authorName ? `<div class="author">${authorName}</div>` : ""}
                        ${prayer.source ? `<div style="font-size: 0.8em; margin-left: 2em; margin-top: 0.5em; font-style: italic;">Source: ${prayer.source} ${prayer.link ? `(<a href="${prayer.link}" target="_blank">link</a>)` : ""}</div>` : ""}
                        ${prayer.phelps ? `<div style="font-size: 0.7em; margin-left: 2em; margin-top: 0.3em; color: #555;">Phelps ID: ${phelpsLinkHtml}</div>` : ""}
                    </div>
                `;
                contentDiv.innerHTML = html;

                if (prayer.phelps) {
                    const transSql = `SELECT version, language FROM writings WHERE phelps = '${prayer.phelps}' AND phelps IS NOT NULL AND phelps != ''`;
                    const translations = await executeQuery(transSql);
                    const currentLangLink = {
                        text: prayer.language,
                        href: `#prayer/${prayer.version}`,
                    };
                    const otherLangLinks = translations.map((t) => ({
                        text: t.language,
                        href: `#prayer/${t.version}`,
                    }));
                    const uniqueLinks = new Map();
                    otherLangLinks.forEach((link) =>
                        uniqueLinks.set(link.href, link),
                    );
                    uniqueLinks.set(currentLangLink.href, currentLangLink);
                    const allLangLinksRaw = Array.from(
                        uniqueLinks.values(),
                    ).sort((a, b) => {
                        const langCompare = a.text.localeCompare(b.text);
                        return langCompare !== 0
                            ? langCompare
                            : a.href.localeCompare(b.href);
                    });
                    const processedLangLinks = [];
                    const langCounts = {};
                    allLangLinksRaw.forEach((link) => {
                        const langCode = link.text;
                        langCounts[langCode] = (langCounts[langCode] || 0) + 1;
                        let displayText = langCode.toUpperCase();
                        if (langCounts[langCode] > 1)
                            displayText += ` (${langCounts[langCode]})`;
                        processedLangLinks.push({
                            text: displayText,
                            href: link.href,
                        });
                    });
                    updateHeaderNavigation(processedLangLinks);
                } else {
                    updateHeaderNavigation([
                        {
                            text: prayer.language.toUpperCase(),
                            href: `#prayer/${prayer.version}`,
                        },
                    ]);
                }
            }

            async function renderPrayersForLanguage(langCode, page = 1) {
                currentPageByLanguage[langCode] = page;
                const offset = (page - 1) * ITEMS_PER_PAGE;
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]);
                const languageDisplayName = langCode.toUpperCase();

                // Step 1: Fetch metadata (version, name, language) without text
                const metadataSql = `SELECT version, name, language FROM writings WHERE language = '${langCode}' ORDER BY name, version LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}`;
                const prayersMetadata = await executeQuery(metadataSql);

                const countSql = `SELECT COUNT(*) as total FROM writings WHERE language = '${langCode}'`;
                const countResult = await executeQuery(countSql);
                const totalPrayers =
                    countResult.length > 0 ? countResult[0].total : 0;
                const totalPages = Math.ceil(totalPrayers / ITEMS_PER_PAGE);

                if (prayersMetadata.length === 0 && page === 1) {
                    contentDiv.innerHTML = `
                        <p>No prayers found for language: ${languageDisplayName}.</p>
                        <p>Query used for metadata:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${metadataSql}</pre>
                        <p><a href="${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(metadataSql)}" target="_blank">Debug metadata query on DoltHub</a></p>
                        <p>Count query used:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${countSql}</pre>
                        <p><a href="${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(countSql)}" target="_blank">Debug count query on DoltHub</a></p>
                    `;
                    return;
                }
                if (prayersMetadata.length === 0 && page > 1) {
                    renderPrayersForLanguage(langCode, Math.max(1, totalPages)); // Go to last valid page
                    return;
                }

                // Step 2: Fetch text for each prayer and prepare for display
                const prayersForDisplay = [];
                for (const pMeta of prayersMetadata) {
                    let opening_text = "Loading text...";
                    let full_text = null;

                    const cached = getCachedPrayerText(pMeta.version);
                    if (cached) {
                        full_text = cached.text;
                        pMeta.name = cached.name || pMeta.name; // Use cached name if available
                    } else {
                        const textSql = `SELECT text FROM writings WHERE version = '${pMeta.version}' LIMIT 1`;
                        const textRows = await executeQuery(textSql);
                        if (textRows.length > 0) {
                            full_text = textRows[0].text;
                            cachePrayerText({
                                version: pMeta.version,
                                text: full_text,
                                name: pMeta.name,
                                language: pMeta.language,
                            });
                        }
                    }
                    opening_text = full_text
                        ? full_text.substring(0, 70) +
                          (full_text.length > 70 ? "..." : "")
                        : "No text available.";

                    prayersForDisplay.push({
                        ...pMeta,
                        opening_text: opening_text,
                    });
                }

                let listHtml = prayersForDisplay
                    .map((p) => {
                        const displayTitle =
                            p.name ||
                            (p.opening_text &&
                            p.opening_text !== "No text available." &&
                            p.opening_text !== "Loading text..."
                                ? p.opening_text
                                : "Untitled Prayer");
                        return `<div class="prayer-list-item"><a href="#prayer/${p.version}">${displayTitle}</a></div>`;
                    })
                    .join("");

                let paginationHtml = "";
                if (totalPages > 1) {
                    paginationHtml = '<div class="pagination">';
                    if (page > 1)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayersForLanguage('${langCode}', ${page - 1})">Previous</button>`;
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayersForLanguage('${langCode}', ${page + 1})">Next</button>`;
                    paginationHtml += "</div>";
                }

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Language: ${languageDisplayName} (Page ${page})</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                    ${paginationHtml}
                `;
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
            }

            async function renderPrayerCodeView(phelpsCode, page = 1) {
                currentPageByPhelpsCode[phelpsCode] = page;
                const offset = (page - 1) * ITEMS_PER_PAGE;

                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]); // Clear previous prayer-specific navigation

                const metadataSql = `SELECT version, name, language, text FROM writings WHERE phelps = '${phelpsCode}' AND phelps IS NOT NULL AND phelps != '' ORDER BY language, name LIMIT ${ITEMS_PER_PAGE} OFFSET ${offset}`;
                const prayersMetadata = await executeQuery(metadataSql);

                const countSql = `SELECT COUNT(*) as total FROM writings WHERE phelps = '${phelpsCode}' AND phelps IS NOT NULL AND phelps != ''`;
                const countResult = await executeQuery(countSql);
                const totalPrayers =
                    countResult.length > 0 ? countResult[0].total : 0;
                const totalPages = Math.ceil(totalPrayers / ITEMS_PER_PAGE);

                if (prayersMetadata.length === 0 && page === 1) {
                    const debugQueryUrl = `${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(metadataSql)}`;
                    contentDiv.innerHTML = `
                        <p>No prayer versions found for Phelps Code: ${phelpsCode}.</p>
                        <p>Query used:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${metadataSql}</pre>
                        <p><a href="${debugQueryUrl}" target="_blank">Debug this query on DoltHub</a></p>`;
                    return;
                }
                if (prayersMetadata.length === 0 && page > 1) {
                    renderPrayerCodeView(phelpsCode, Math.max(1, totalPages)); // Go to last valid page
                    return;
                }

                const prayersForDisplay = prayersMetadata.map((p) => {
                    // Cache text if fetched directly
                    if (p.text && !getCachedPrayerText(p.version)) {
                        cachePrayerText({
                            version: p.version,
                            text: p.text,
                            name: p.name,
                            language: p.language,
                        });
                    }
                    const opening_text = p.text
                        ? p.text.substring(0, 70) +
                          (p.text.length > 70 ? "..." : "")
                        : "No text preview.";
                    return { ...p, opening_text };
                });

                let listHtml = prayersForDisplay
                    .map((p) => {
                        const displayTitle =
                            p.name || p.opening_text || "Untitled Prayer";
                        return `<div class="prayer-code-list-item">
                                    <a href="#prayer/${p.version}">
                                        ${p.language.toUpperCase()}: ${displayTitle}
                                    </a>
                                </div>`;
                    })
                    .join("");

                let paginationHtml = "";
                if (totalPages > 1) {
                    paginationHtml = '<div class="pagination">';
                    if (page > 1)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayerCodeView('${phelpsCode}', ${page - 1})">Previous</button>`;
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderPrayerCodeView('${phelpsCode}', ${page + 1})">Next</button>`;
                    paginationHtml += "</div>";
                }

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayer Code</span>
                            <span id="blocktitle">${phelpsCode} (Page ${page})</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                    ${paginationHtml}
                `;
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
            }

            async function renderLanguageList() {
                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom(); // For spinner
                updateHeaderNavigation([]);
                currentPageByLanguage = {};
                currentPageBySearchTerm = {};
                currentPageByPhelpsCode = {};

                const sql = `SELECT language, COUNT(*) as prayer_count FROM writings WHERE language IS NOT NULL AND language != '' GROUP BY language ORDER BY language`;
                const languagesWithCounts = await executeQuery(sql);

                if (languagesWithCounts.length === 0) {
                    const debugQueryUrl = `${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(sql)}`;
                    contentDiv.innerHTML = `
                        <p>No languages found in the database.</p>
                        <p>Query used:</p>
                        <pre style="white-space: pre-wrap; word-break: break-all; background: #eee; padding: 10px; border-radius: 4px;">${sql}</pre>
                        <p><a href="${debugQueryUrl}" target="_blank">Debug this query on DoltHub</a></p>
                    `;
                    return;
                }

                let listHtml = languagesWithCounts
                    .map((langData) => {
                        const langCode = langData.language;
                        const prayerCount = langData.prayer_count;
                        return `<button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" onclick="window.location.hash='#prayers/${langCode}'">
                                        ${langCode.toUpperCase()} (${prayerCount})
                                    </button>`;
                    })
                    .join("\n");

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Prayers</span>
                            <span id="blocktitle">Available Languages</span>
                        </h2>
                    </header>
                    <div class="language-buttons-container">${listHtml}</div>
                `;

                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom(); // Upgrade MDL components
                }
            }

            async function renderSearchResults(searchTerm, page = 1) {
                currentPageBySearchTerm[searchTerm] = page;

                contentDiv.innerHTML =
                    '<div class="mdl-spinner mdl-js-spinner is-active" style="margin: auto; display: block;"></div>';
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
                updateHeaderNavigation([]);

                const headerSearchInput = document.getElementById(
                    "header-search-field",
                );
                if (
                    headerSearchInput &&
                    headerSearchInput.value !== searchTerm
                ) {
                    headerSearchInput.value = searchTerm;
                }

                const saneSearchTermForSql = searchTerm.replace(/'/g, "''"); // For SQL LIKE
                const lowerSearchTerm = searchTerm.toLowerCase(); // For JS string includes

                // 1. Local Cache Search
                const localFoundItems = [];
                const allCached = getAllCachedPrayers();
                allCached.forEach((cachedPrayer) => {
                    let match = false;
                    if (
                        cachedPrayer.text &&
                        cachedPrayer.text
                            .toLowerCase()
                            .includes(lowerSearchTerm)
                    ) {
                        match = true;
                    }
                    if (
                        !match &&
                        cachedPrayer.name &&
                        cachedPrayer.name
                            .toLowerCase()
                            .includes(lowerSearchTerm)
                    ) {
                        match = true;
                    }
                    if (match) {
                        localFoundItems.push({
                            version: cachedPrayer.version,
                            name: cachedPrayer.name,
                            language: cachedPrayer.language,
                            opening_text: cachedPrayer.text
                                ? cachedPrayer.text.substring(0, 100) +
                                  (cachedPrayer.text.length > 100 ? "..." : "")
                                : "No text preview.",
                            source: "cache",
                        });
                    }
                });

                // 2. Database `name` Search
                const dbNameSql = `SELECT version, name, language FROM writings WHERE name LIKE '%${saneSearchTermForSql}%' ORDER BY name, version`;
                const dbNameItemsRaw = await executeQuery(dbNameSql);
                const dbNameItems = dbNameItemsRaw.map((item) => ({
                    ...item,
                    source: "db_name",
                }));

                // 3. Combine & Deduplicate
                let combinedResults = [];
                const processedVersions = new Set();

                localFoundItems.forEach((item) => {
                    if (!processedVersions.has(item.version)) {
                        combinedResults.push(item);
                        processedVersions.add(item.version);
                    }
                });

                dbNameItems.forEach((item) => {
                    if (!processedVersions.has(item.version)) {
                        combinedResults.push(item);
                        processedVersions.add(item.version);
                    }
                });

                // 4. Pagination (Client-Side for Combined Results)
                const totalResults = combinedResults.length;
                const totalPages = Math.ceil(totalResults / ITEMS_PER_PAGE);

                if (page > totalPages && totalPages > 0) {
                    page = totalPages;
                    currentPageBySearchTerm[searchTerm] = page;
                } else if (totalPages === 0 && page > 1) {
                    // Handles case where search yields 0 results but URL has page > 1
                    page = 1;
                    currentPageBySearchTerm[searchTerm] = page;
                }

                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                const paginatedCombinedResults = combinedResults.slice(
                    startIndex,
                    startIndex + ITEMS_PER_PAGE,
                );

                // 5. Prepare display items (fetch missing texts for DB items if necessary)
                const displayItems = [];
                for (const item of paginatedCombinedResults) {
                    let displayItem = { ...item };
                    if (item.source === "db_name" && !item.opening_text) {
                        const cached = getCachedPrayerText(item.version);
                        if (cached) {
                            displayItem.name = cached.name || item.name;
                            displayItem.opening_text = cached.text
                                ? cached.text.substring(0, 100) +
                                  (cached.text.length > 100 ? "..." : "")
                                : "No text preview.";
                        } else {
                            const textQuerySql = `SELECT text, name FROM writings WHERE version = '${item.version}' LIMIT 1`;
                            const textRows = await executeQuery(textQuerySql);
                            if (textRows.length > 0) {
                                const fetchedText = textRows[0].text;
                                const fetchedName = textRows[0].name;
                                displayItem.name = fetchedName || item.name;
                                displayItem.opening_text = fetchedText
                                    ? fetchedText.substring(0, 100) +
                                      (fetchedText.length > 100 ? "..." : "")
                                    : "No text preview.";
                                cachePrayerText({
                                    version: item.version,
                                    text: fetchedText,
                                    name: displayItem.name,
                                    language: item.language,
                                });
                            } else {
                                displayItem.opening_text =
                                    "Text not found for preview.";
                            }
                        }
                    }
                    displayItems.push(displayItem);
                }

                if (totalResults === 0) {
                    const searchExplanationForNoResults = `
                        <div style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9em;">
                            <p style="margin-bottom: 5px;"><strong>Search Information:</strong></p>
                            <ul style="margin-top: 0; padding-left: 20px;">
                                <li>This search looked for "${searchTerm}" in prayer <strong>titles</strong> from the main database.</li>
                                <li>It also checked the <strong>full text</strong> of ${allCached.length} prayer(s) stored in your browser's local cache (from previously viewed or searched items).</li>
                                <li>If you can't find a prayer, try browsing the <a href="#prayers">language lists</a> to view prayers. This adds them to your local cache, which can help future searches find them by their text.</li>
                            </ul>
                        </div>`;

                    contentDiv.innerHTML = `
                        <p>No prayers found matching "${searchTerm}".</p>
                        ${searchExplanationForNoResults}
                        <p style="margin-top: 15px;">For a more comprehensive text search across the entire database (not just titles or your local cache), try <a href="https://tiddly.holywritings.net/workspace" target="_blank">tiddly.holywritings.net/workspace</a>.</p>
                        <p>Debug: <a href="${DOLTHUB_REPO_QUERY_URL_BASE}${encodeURIComponent(dbNameSql)}" target="_blank">View DB Name Query (Titles)</a></p>
                    `;
                    return;
                }

                let listHtml = displayItems
                    .map((p) => {
                        const displayTitle =
                            p.name ||
                            (p.opening_text !== "No text preview." &&
                            p.opening_text !== "Text not found for preview."
                                ? p.opening_text
                                : "Untitled Prayer");
                        return `<div class="prayer-list-item"><a href="#prayer/${p.version}">${displayTitle}</a> (${p.language ? p.language.toUpperCase() : "N/A"})</div>`;
                    })
                    .join("");

                let paginationHtml = "";
                if (totalPages > 1) {
                    const escapedSearchTerm = searchTerm
                        .replace(/'/g, "\\'")
                        .replace(/"/g, '\\"');
                    paginationHtml = '<div class="pagination">';
                    if (page > 1)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderSearchResults('${escapedSearchTerm}', ${page - 1})">Previous</button>`;
                    paginationHtml += ` <span>Page ${page} of ${totalPages}</span> `;
                    if (page < totalPages)
                        paginationHtml += `<button class="mdl-button mdl-js-button mdl-button--raised" onclick="renderSearchResults('${escapedSearchTerm}', ${page + 1})">Next</button>`;
                    paginationHtml += "</div>";
                }

                const searchInfoHtml = `
                    <div style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9em;">
                        <p style="margin-bottom: 5px;"><strong>How this search works:</strong></p>
                        <ul style="margin-top: 0; padding-left: 20px;">
                            <li>It searches prayer <strong>titles</strong> in the main database.</li>
                            <li>It also searches the <strong>full text</strong> of prayers you have previously viewed or found in other searches (these are stored in your browser's local cache).</li>
                            <li>To improve full-text search results for specific prayers, try viewing them first by navigating through the <a href="#prayers">language lists</a>. This adds their text to your local cache, making them searchable here.</li>
                        </ul>
                    </div>`;

                const tiddlySuggestionHtml = `<p style="margin-top: 20px; text-align: center; font-size: 0.9em;">For more comprehensive text search, or if you can't find what you're looking for, try <a href="https://tiddly.holywritings.net/workspace" target="_blank">tiddly.holywritings.net/workspace</a>.</p>`;

                contentDiv.innerHTML = `
                    <header>
                        <h2>
                            <span id="category">Search Results</span>
                            <span id="blocktitle">For "${searchTerm}" (Page ${page})</span>
                        </h2>
                    </header>
                    <div>${listHtml}</div>
                    ${paginationHtml}
                    ${searchInfoHtml}
                    ${tiddlySuggestionHtml}
                `;
                if (typeof componentHandler !== "undefined")
                    componentHandler.upgradeDom();
            }

            function handleRouteChange() {
                const hash = window.location.hash;
                const hashParts = hash.split("?page=");
                const mainHash = hashParts[0];
                let pageParam = 1;
                if (hashParts.length > 1 && hashParts[1]) {
                    const parsedPage = parseInt(hashParts[1], 10);
                    if (!isNaN(parsedPage) && parsedPage > 0) {
                        pageParam = parsedPage;
                    }
                }

                if (mainHash.startsWith("#search/prayers/")) {
                    const searchTerm = decodeURIComponent(
                        mainHash.substring("#search/prayers/".length),
                    );
                    if (searchTerm) {
                        const page =
                            currentPageBySearchTerm[searchTerm] || pageParam;
                        renderSearchResults(searchTerm, page);
                    } else {
                        renderLanguageList();
                    }
                } else if (mainHash.startsWith("#prayercode/")) {
                    const phelpsCode = decodeURIComponent(
                        mainHash.substring("#prayercode/".length),
                    );
                    if (phelpsCode) {
                        const page =
                            currentPageByPhelpsCode[phelpsCode] || pageParam;
                        renderPrayerCodeView(phelpsCode, page);
                    } else {
                        renderLanguageList(); // Fallback if no phelps code provided
                    }
                } else if (mainHash.startsWith("#prayer/")) {
                    const versionId = mainHash.substring("#prayer/".length);
                    if (versionId) renderPrayer(versionId);
                    else renderLanguageList();
                } else if (mainHash.startsWith("#prayers/")) {
                    const langCode = mainHash.substring("#prayers/".length);
                    if (langCode) {
                        const page =
                            currentPageByLanguage[langCode] || pageParam;
                        renderPrayersForLanguage(langCode, page);
                    } else {
                        renderLanguageList();
                    }
                } else if (
                    mainHash === "#prayers" ||
                    mainHash === "" ||
                    mainHash === "#"
                ) {
                    renderLanguageList();
                } else {
                    // This regex was for old-style phelps links.
                    // The new #prayercode/ route is preferred.
                    // We can keep this for backward compatibility or remove.
                    // For now, let it default to language list.
                    const phelpsRegex = /^#([A-Z]{2}\d{3,5}[A-Z]{0,3})$/i;
                    const phelpsMatch = mainHash.match(phelpsRegex);
                    if (phelpsMatch && phelpsMatch[1]) {
                        const phelpsCode = phelpsMatch[1].toUpperCase();
                        // Redirect to new prayercode view or handle as before
                        console.log(
                            "Old style Phelps code detected:",
                            phelpsCode,
                            " - Consider updating link to #prayercode/",
                            phelpsCode,
                        );
                        // Optionally, redirect: window.location.hash = `#prayercode/${phelpsCode}`;
                        renderPrayerCodeView(phelpsCode, 1); // Or redirect to new format
                    } else {
                        console.log(
                            "Unhandled hash:",
                            mainHash,
                            "defaulting to language list.",
                        );
                        renderLanguageList();
                    }
                }
            }

            window.renderPrayersForLanguage = renderPrayersForLanguage;
            window.renderSearchResults = renderSearchResults;
            window.renderPrayerCodeView = renderPrayerCodeView;

            document.addEventListener("DOMContentLoaded", () => {
                const searchInput = document.getElementById(
                    "header-search-field",
                );
                if (searchInput) {
                    searchInput.addEventListener("keypress", function (e) {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            const searchTerm = searchInput.value.trim();
                            if (searchTerm) {
                                currentPageBySearchTerm[searchTerm] = 1;
                                window.location.hash = `#search/prayers/${encodeURIComponent(searchTerm)}`;
                            }
                        }
                    });
                }

                if (typeof componentHandler !== "undefined") {
                    componentHandler.upgradeDom();
                }
                handleRouteChange();
            });

            window.addEventListener("hashchange", handleRouteChange);
        </script>

        <!-- Add ServiceWorker and manup.js -->
        <script>
            //This is the "Offline copy of pages" service worker
            if (navigator.serviceWorker.controller) {
                console.log(
                    "[PWA Builder] active service worker found, no need to register",
                );
            } else {
                navigator.serviceWorker
                    .register("pwabuilder-sw.js", {
                        scope: "./",
                    })
                    .then(function (reg) {
                        console.log(
                            "Service worker has been registered for scope:" +
                                reg.scope,
                        );
                    });
            }
        </script>
    </body>
</html>
